<app-loading-spinner *ngIf="isLoading"></app-loading-spinner>
<button
  (click)="onBack()"
  class="text-textLight dark:text-textDark mb-6 flex items-center gap-2"
>
  <i class="fa-solid fa-arrow-left"></i>
  Back
</button>

<div class="overflow-x-auto">
  <div
    class="min-w-[1200px] bg-tileLight dark:bg-tileBlack shadow-lg rounded-lg overflow-x-auto p-5"
  >
    <div *ngIf="!hasData" class="text-center py-8">
      <p class="text-[#494949] dark:text-textDark">--No Data Available--</p>
      <img
        src="assets/images/NoData.png"
        alt="No Data"
        class="w-20 h-20 mx-auto"
      />
    </div>
    <div *ngIf="hasData">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-normal text-textLight dark:text-textDark mb-6">
          Individual Farmers Audits ({{ audits.length | number : "2.0" }})
        </h2>
        <!-- Search bar -->
        <div
          class="flex items-center rounded-full px-4 py-2 w-96 bg-[#F1F1F1] dark:bg-[#272F45] text-textLight dark:text-textDark mb-5"
        >
          <input
            type="text"
            placeholder="Search by Farmer Name/Phone"
            [(ngModel)]="searchTerm"
            (keyup.enter)="onSearch()"
            (keyup.esc)="offSearch()"
            class="bg-transparent outline-none w-full text-textLight dark:text-textDark"
          />

          <!-- Search button -->
          <button
            type="button"
            class="text-gray-500 hover:text-gray-700 focus:outline-none mr-2"
            (click)="onSearch()"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 10-14 0 7 7 0 0014 0z"
              />
            </svg>
          </button>

          <!-- Clear button -->
          <button
            type="button"
            class="text-gray-500 hover:text-gray-700 focus:outline-none"
            (click)="offSearch()"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
      </div>

      <table
        class="w-full divide-y divide-gray-200 dark:divide-[#4B555A] table-auto whitespace-nowrap gap-4"
      >
        <thead>
          <tr>
            <th
              class="px-4 py-3 font-normal text-textLight dark:text-textDark text-left"
            >
              No
            </th>
            <th
              class="px-4 py-3 font-normal text-textLight dark:text-textDark text-left"
            >
              Farmer Name
            </th>
            <th
              class="px-4 py-3 font-normal text-textLight dark:text-textDark text-left"
            >
              District
            </th>
            <th
              class="px-4 py-3 font-normal text-textLight dark:text-textDark text-left"
            >
              Phone Number
            </th>
            <th
              class="px-4 py-3 font-normal text-textLight dark:text-textDark text-left"
            >
              Certificate Name
            </th>
            <th
              class="px-4 py-3 font-normal text-textLight dark:text-textDark text-left"
            >
              Application
            </th>
            <th
              class="px-4 py-3 font-normal text-textLight dark:text-textDark text-left"
            >
              Crops
            </th>
            <th
              class="px-4 py-3 font-normal text-textLight dark:text-textDark text-left"
            >
              Status
            </th>
            <th
              class="px-4 py-3 font-normal text-textLight dark:text-textDark text-left"
            >
              Assign
            </th>
            <th
              class="px-4 py-3 font-normal text-textLight dark:text-textDark text-left"
            >
              Assign By
            </th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let audit of audits; let i = index"
            class="border-b border-gray-200 dark:border-[#4B555A]"
          >
            <td class="px-4 py-3 text-left text-textLight dark:text-textDark">
              {{ ("0" + (i + 1)).slice(-2) }}
            </td>
            <td class="px-4 py-3 text-left text-textLight dark:text-textDark">
              {{ getFarmerName(audit) }}
            </td>
            <td class="px-4 py-3 text-left text-textLight dark:text-textDark">
              {{ audit.farmerDistrict || "--" }}
            </td>
            <td class="px-4 py-3 text-left text-textLight dark:text-textDark">
              {{ audit.farmerPhoneNumber || "--" }}
            </td>
            <td class="px-4 py-3 text-left text-textLight dark:text-textDark">
              {{ audit.certificateName || "--" }}
            </td>
            <td class="px-4 py-3 text-left text-textLight dark:text-textDark">
              {{ audit.certificateApplicable || "--" }}
            </td>

            <td class="px-4 py-3 text-center">
              <button
                (click)="openCropsModal(audit)"
                class="w-6 h-6 text-blue-500 hover:text-blue-700"
              >
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M3 14C3 9.02944 7.02944 5 12 5C16.9706 5 21 9.02944 21 14M17 14C17 16.7614 14.7614 19 12 19C9.23858 19 7 16.7614 7 14C7 11.2386 9.23858 9 12 9C14.7614 9 17 11.2386 17 14Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
            </td>
            <td class="px-4 py-3 text-left">
              <span [class]="getStatusClass(audit.status)">
                {{ audit.status || "--" }}
              </span>
            </td>
            <td class="px-4 py-3 text-left">
              <span
                [class]="getAssignClass(audit.officerFirstName ?? null)"
                class="px-2 py-1 rounded-full text-xs font-medium"
              >
                {{ getAssignText(audit.officerFirstName ?? null) }}
              </span>
            </td>
            <td class="px-4 py-3 text-left text-textLight dark:text-textDark">
              {{ getOfficerName(audit) }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Crops Modal -->
<div
  *ngIf="showCropsModal"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
  (click)="closeCropsModal()"
>
  <div
    class="bg-white dark:bg-tileBlack rounded-2xl shadow-xl w-full max-w-lg max-h-[80vh] overflow-hidden"
    (click)="$event.stopPropagation()"
  >
    <h2
      class="text-center text-xl font-semibold text-black dark:text-textDark my-6"
    >
      Crops included in the certification
    </h2>

    <!-- Modal Body -->
    <div class="p-6 overflow-y-auto max-h-[60vh]">
      <app-loading-spinner *ngIf="isLoadingCrops"></app-loading-spinner>

      <div *ngIf="!isLoadingCrops">
        <div *ngIf="selectedAuditCrops.length === 0" class="text-center py-8">
          <p class="text-gray-500 dark:text-gray-400">
            No crops found for this certificate
          </p>
        </div>

        <div
          *ngIf="selectedAuditCrops.length > 0"
          class="grid grid-cols-1 gap-3"
        >
          <div *ngFor="let crop of selectedAuditCrops">
            <div class="flex items-center ml-40">
              <span class="text-textLight dark:text-textDark font-medium">
                <i class="fa-solid fa-circle text-xs mr-2"></i>
                {{ crop.cropNameEnglish }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="flex justify-center my-6">
      <button
        (click)="closeCropsModal()"
        class="bg-[#74788D] hover:bg-gray-600 text-[#D3D3D3] px-4 py-2 rounded-lg font-medium transition-colors"
      >
        Cancel
      </button>
    </div>
  </div>
</div>
