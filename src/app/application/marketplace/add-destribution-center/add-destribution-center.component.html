<app-loading-spinner *ngIf="isLoading"></app-loading-spinner>

<button class="mb-2 mt-0 text-textLight dark:text-textDark" (click)="back()">
  <i class="fa-solid fa-arrow-left"></i>
  Back
</button>

<div class="w-full mx-auto pt-6 py-6 px-12 bg-white dark:bg-tileBlack rounded-lg shadow-md">
  <h2 class="font-medium text-[#292929] mb-6 dark:text-textDark">
    Add Distribution Centre
  </h2>

  <form [formGroup]="distributionForm" (ngSubmit)="onSubmit()">
    <!-- Row 1 -->

    <div class="flex flex-col md:flex-row md:space-x-4 mb-6 gap-8">
      <div class="flex-1 mb-4 md:mb-0">
        <label class="block text-sm font-medium text-[#534E4E] dark:text-textDark mb-2">Distribution Centre Name
          *</label>
        <input type="text" formControlName="name" (input)="onInputChange($event, 'centreName')"
          (blur)="onCentreNameBlur()" [class]="
      ' dark:text-textDark bg-tileLight dark:bg-tileBlack w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ' +
      (isFieldInvalid('name') ? 'border-red-500' : 'border-gray-300')
    " />
        <div *ngIf="isFieldInvalid('name')" class="text-red-500 text-sm mt-1">
          {{ getFieldError("name") }}
        </div>
      </div>
      <div class="flex-1 mb-4 md:mb-0">
        <label class="dark:text-textDark block text-sm font-medium text-[#534E4E] mb-2">Company *</label>
        <p-dropdown formControlName="company" [options]="companyOptions" optionLabel="label" optionValue="value"
          [filter]="true" filterBy="label" [showClear]="false" placeholder="Select a company" styleClass="w-full"
          panelStyleClass="custom-dropdown-panel" class="block w-full p-dropdown-custom"
          [class.border-red-500]="isFieldInvalid('company')">
        </p-dropdown>
        <div *ngIf="isFieldInvalid('company')" class="text-red-500 text-sm mt-1">
          {{ getFieldError("company") }}
        </div>
      </div>
    </div>

    <!-- Row 2 -->
    <div class="flex flex-col md:flex-row md:space-x-4 mb-4 gap-8">
      <div class="flex-1 mb-4 md:mb-0">
        <label class="block text-sm font-medium text-[#534E4E] mb-2 dark:text-textDark">
          Contact Number 01 *
        </label>
        <div class="flex">
          <p-dropdown formControlName="contact1Code" [options]="countries" optionLabel="dialCode" optionValue="dialCode"
            styleClass="border border-gray-300 mr-2 rounded-l-md bg-white dark:bg-tileBlack text-gray-800 dark:text-textDark custom-dropdown"
            [style]="{ width: '120px' }" [ngClass]="{ 'border-red-500': isFieldInvalid('contact1Code') }">
            <!-- Dropdown items -->
            <ng-template let-country pTemplate="item">
              <div class="flex items-center gap-2">
                <img [src]="getFlagUrl(country.code)" width="24" height="18" [alt]="country.name" />
                <span>{{ country.dialCode }}</span>
              </div>
            </ng-template>

            <!-- Selected item -->
            <ng-template let-country pTemplate="selectedItem">
              <div class="flex items-center gap-2" *ngIf="country">
                <img [src]="getFlagUrl(country.code)" width="24" height="18" [alt]="country.name" />
                <span>{{ country.dialCode }}</span>
              </div>
            </ng-template>
          </p-dropdown>

          <input type="tel" formControlName="contact1" placeholder="7XXXXXXXX" maxlength="9"
            (input)="onInputChange($event, 'phone')" [class]="
          'dark:text-textDark bg-tileLight dark:bg-tileBlack flex-1 px-3 py-2 border rounded-r-md focus:outline-none focus:ring-2 focus:ring-blue-500 ' +
          (isFieldInvalid('contact1') ? 'border-red-500' : 'border-gray-300')
        " />
        </div>
        <div *ngIf="isFieldInvalid('contact1')" class="text-red-500 text-sm mt-1">
          {{ getFieldError("contact1") }}
        </div>
      </div>

      <div class="flex-1">
        <label class="block text-sm font-medium text-[#534E4E] mb-2 dark:text-textDark">
          Contact Number 02
        </label>
        <div class="flex">
          <p-dropdown formControlName="contact2Code" [options]="countries" optionLabel="dialCode" optionValue="dialCode"
            styleClass="border border-gray-300 mr-2 rounded-l-md bg-white dark:bg-tileBlack text-gray-800 dark:text-textDark custom-dropdown"
            [style]="{ width: '120px' }" [ngClass]="{ 'border-red-500': isFieldInvalid('contact2Code') }">
            <!-- Dropdown items -->
            <ng-template let-country pTemplate="item">
              <div class="flex items-center gap-2">
                <img [src]="getFlagUrl(country.code)" width="24" height="18" [alt]="country.name" />
                <span>{{ country.dialCode }}</span>
              </div>
            </ng-template>

            <!-- Selected item -->
            <ng-template let-country pTemplate="selectedItem">
              <div class="flex items-center gap-2" *ngIf="country">
                <img [src]="getFlagUrl(country.code)" width="24" height="18" [alt]="country.name" />
                <span>{{ country.dialCode }}</span>
              </div>
            </ng-template>
          </p-dropdown>

          <input type="tel" formControlName="contact2" placeholder="7XXXXXXXX" maxlength="9"
            (input)="onInputChange($event, 'phone')" [class]="
          'dark:text-textDark bg-tileLight dark:bg-tileBlack flex-1 px-3 py-2 border rounded-r-md focus:outline-none focus:ring-2 focus:ring-blue-500 ' +
          (isFieldInvalid('contact2') ? 'border-red-500' : 'border-gray-300')
        " />
        </div>
        <div *ngIf="isFieldInvalid('contact2')" class="text-red-500 text-sm mt-1">
          {{ getFieldError("contact2") }}
        </div>
      </div>
    </div>

    <!-- Row 3 -->
    <div class="flex flex-col md:flex-row md:space-x-4 mb-4 gap-8">
      <div class="flex-1 mb-4 md:mb-0">
        <label class="block text-sm font-medium text-[#534E4E] mb-2 dark:text-textDark">Latitude *</label>
        <input type="text" formControlName="latitude" placeholder="e.g., 6.9271"
          (input)="onInputChange($event, 'coordinates')" [class]="
      ' dark:text-textDark bg-tileLight dark:bg-tileBlack w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ' +
      (isFieldInvalid('latitude') ? 'border-red-500' : 'border-gray-300')
    " />
        <div *ngIf="isFieldInvalid('latitude')" class="text-red-500 text-sm mt-1">
          {{ getFieldError("latitude") }}
        </div>
      </div>

      <!-- Updated Longitude input -->
      <div class="flex-1">
        <label class="block text-sm font-medium text-[#534E4E] mb-2 dark:text-textDark">Longitude *</label>
        <input type="text" formControlName="longitude" placeholder="e.g., 79.8612"
          (input)="onInputChange($event, 'coordinates')" [class]="
      ' dark:text-textDark bg-tileLight dark:bg-tileBlack w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ' +
      (isFieldInvalid('longitude') ? 'border-red-500' : 'border-gray-300')
    " />
        <div *ngIf="isFieldInvalid('longitude')" class="text-red-500 text-sm mt-1">
          {{ getFieldError("longitude") }}
        </div>
      </div>

    </div>

    <!-- Row 4 -->
    <div class="flex flex-col md:flex-row md:space-x-4 mb-4 gap-8">
      <div class="flex-1 mb-4 md:mb-0">
  <label class="block text-sm font-medium text-[#534E4E] mb-2 dark:text-textDark">Email *</label>
  <input type="text" formControlName="email" (input)="onInputChange($event, 'email')" [class]="
    ' dark:text-textDark bg-tileLight dark:bg-tileBlack w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ' +
    (isFieldInvalid('email') ? 'border-red-500' : 'border-gray-300')
  " />
  <div *ngIf="isFieldInvalid('email')" class="text-red-500 text-sm mt-1">
    {{ getFieldError("email") }}
  </div>
</div>


      <div class="flex-1">
        <label class="block text-sm font-medium text-[#534E4E] mb-2 dark:text-textDark">Country *</label>
        <input type="text" formControlName="country" readonly
          class="dark:text-textDark bg-gray-100 dark:bg-gray-700 w-full px-3 py-2 border border-gray-300 rounded-md cursor-not-allowed opacity-75" />
        <div *ngIf="isFieldInvalid('country')" class="text-red-500 text-sm mt-1">
          {{ getFieldError("country") }}
        </div>
      </div>
    </div>

    <!-- Row 5 -->
    <div class="flex flex-col md:flex-row md:space-x-4 mb-4 gap-8">
      <div class="flex-1 mb-4 md:mb-0">
        <label class="block text-sm font-medium text-[#534E4E] mb-2 dark:text-textDark">Province *</label>
        <p-dropdown formControlName="province" [options]="provinceOptions" optionLabel="label" optionValue="value"
          [filter]="true" filterBy="label" [showClear]="false" placeholder="Select Province"
          (onChange)="onProvinceChange()" styleClass="w-full" panelStyleClass="custom-dropdown-panel"
          class="block w-full p-dropdown-custom" [class.border-red-500]="isFieldInvalid('province')">
        </p-dropdown>
        <div *ngIf="isFieldInvalid('province')" class="text-red-500 text-sm mt-1">
          {{ getFieldError("province") }}
        </div>
      </div>


      <div class="flex-1">
        <label class="block text-sm font-medium text-[#534E4E] mb-2 dark:text-textDark">District *</label>
        <p-dropdown formControlName="district" [options]="districtOptions" optionLabel="label" optionValue="value"
          [filter]="true" filterBy="label" [showClear]="false" [disabled]="!distributionForm.get('province')?.value"
          placeholder="Select District" (onChange)="onDistrictChange()" styleClass="w-full"
          panelStyleClass="custom-dropdown-panel" class="block w-full p-dropdown-custom"
          [class.border-red-500]="isFieldInvalid('district')">
        </p-dropdown>
        <div *ngIf="isFieldInvalid('district')" class="text-red-500 text-sm mt-1">
          {{ getFieldError("district") }}
        </div>
      </div>
    </div>

    <!-- Row 6 -->
    <div class="flex flex-col md:flex-row md:space-x-4 mb-6 gap-8">
      <div class="flex-1 mb-4 md:mb-0">
        <label class="block text-sm font-medium text-[#534E4E] mb-2 dark:text-textDark">City *</label>
        <input type="text" formControlName="city" (input)="onInputChange($event, 'text')" [class]="
      ' dark:text-textDark bg-tileLight dark:bg-tileBlack w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ' +
      (isFieldInvalid('city') ? 'border-red-500' : 'border-gray-300')
    " />
        <div *ngIf="isFieldInvalid('city')" class="text-red-500 text-sm mt-1">
          {{ getFieldError("city") }}
        </div>
      </div>
      <div class="flex-1 mb-4 md:mb-0">
        <label class="block text-sm font-medium text-[#534E4E] mb-2 dark:text-textDark">Distribution Centre Reg Code
          *</label>
        <div class="relative">
          <input type="text" formControlName="regCode" readonly
            class="dark:text-textDark bg-gray-100 dark:bg-gray-700 w-full px-3 py-2 border border-gray-300 rounded-md cursor-not-allowed opacity-75" />
          <div *ngIf="isLoadingregcode" class="absolute inset-y-0 right-0 flex items-center pr-3">
            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div>
          </div>
        </div>
        <div *ngIf="isFieldInvalid('regCode')" class="text-red-500 text-sm mt-1">
          {{ getFieldError("regCode") }}
        </div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="flex justify-end space-x-4 pt-6">
      <button type="button" (click)="onCancel()"
        class="px-4 w-30 py-2 bg-[#74788D] border border-gray-300 rounded-md text-[#D3D3D3] focus:outline-none focus:ring-2 focus:ring-blue-500">
        Cancel
      </button>
      <button type="submit" [class]="
          'px-4 min-w-30 py-2 bg-[#3980C0] rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-[#D3D3D3] ' +
          (distributionForm.invalid
            ? 'bg-gray-400 text-gray-700 cursor-not-allowed'
            : 'bg-[#3980C0] text-white  hover:bg-[#3980C0]')
        ">
        Save
      </button>
    </div>
  </form>
</div>