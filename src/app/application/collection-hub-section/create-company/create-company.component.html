<app-loading-spinner *ngIf="isLoading"></app-loading-spinner>
<button (click)="back()"
 class="ml-5 text-textLight dark:text-textDark">
  <i class="fa-solid fa-arrow-left"></i>
  Back
</button>
<div class="h-[20px]"></div>

<div class="mx-auto p-6 bg-white dark:bg-tileBlack rounded-lg shadow-mg">
  <div *ngIf="itemId === null">
    <div *ngIf="selectedPage === 'pageOne'">
      <h2 class="text-2xl mb-6 text-textLight dark:text-textDark">
        Add Company Details
      </h2>

      <!-- Logo and Favicon Upload Section -->
      <div class="flex justify-between items-center mb-8">
        <div class="flex items-center mb-8">
  <label class="block text-sm font-medium text-gray-700 dark:text-textDark mb-2">
    Add Log *
  </label>
  <div class="relative ml-5">
    <input type="file" id="logoUpload" name="logoUpload" accept="image/*" (change)="onLogoChange($event)"
      class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
    <div
      class="w-20 h-20 border-2 border-[#3980C0] dark:border-gray-600 rounded-lg flex items-center justify-center bg-gray-50 dark:bg-tileBlack hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors cursor-pointer"
      [ngClass]="{'border-red-500': isFieldInvalid('logo')}">
      <div *ngIf="!companyData.logo" class="text-center">
        <svg class="w-8 h-8 text-gray-400 dark:text-gray-500 mx-auto mb-1" fill="none" stroke="currentColor"
          viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6">
          </path>
        </svg>
      </div>
      <img *ngIf="companyData.logo" [src]="companyData.logo" alt="Logo preview"
        class="w-full h-full object-cover rounded-lg" />
      <button *ngIf="companyData.logo" (click)="removeLogo($event)" type="button"
        class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition-colors">
        ×
      </button>
    </div>
  </div>
  <div class="ml-3">
    <span *ngIf="isFieldInvalid('logo')" class="text-red-600 text-sm block">Logo is required.</span>
    <span *ngIf="logoSizeError" class="text-red-600 text-sm block">Image must be less than 1MB</span>
    <span class="text-gray-500 text-xs block">Upload an image less than 1MB</span>
  </div>
</div>

        <!-- Update the Favicon Upload Section -->
        <div class="flex items-center mb-8">
  <label class="block text-sm font-medium text-gray-700 dark:text-textDark mb-2">
    Add Favicon *
  </label>
  <div class="relative ml-5">
    <input type="file" id="faviconUpload" name="faviconUpload" accept="image/*,.ico" (change)="onFaviconChange($event)"
      class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
    <div
      class="w-20 h-20 border-2 border-[#3980C0] dark:border-gray-600 rounded-lg flex items-center justify-center bg-gray-50 dark:bg-tileBlack hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors cursor-pointer"
      [ngClass]="{'border-red-500': isFieldInvalid('favicon')}">
      <div *ngIf="!companyData.favicon" class="text-center">
        <svg class="w-8 h-8 text-gray-400 dark:text-gray-500 mx-auto mb-1" fill="none" stroke="currentColor"
          viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6">
          </path>
        </svg>
      </div>
      <img *ngIf="companyData.favicon" [src]="companyData.favicon" alt="Favicon preview"
        class="w-full h-full object-cover rounded-lg" />
      <button *ngIf="companyData.favicon" (click)="removeFavicon($event)" type="button"
        class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition-colors">
        ×
      </button>
    </div>
  </div>
  <div class="ml-3">
    <span *ngIf="isFieldInvalid('favicon')" class="text-red-600 text-sm block">Favicon is required.</span>
    <span *ngIf="faviconSizeError" class="text-red-600 text-sm block">Image must be less than 1MB</span>
    <span class="text-gray-500 text-xs block">Upload an image less than 1MB</span>
  </div>
</div>
      </div>

      <hr class="my-5" />

      <div>
        <div class="pb-6">
          <label for="regNumber" class="block text-sm font-medium text-gray-700 dark:text-textDark">Registration Number
            of the Company <span style="color: #2E2E2E">*</span></label>
          <input id="regNumber" name="regNumber" [(ngModel)]="companyData.regNumber" (blur)="onBlur('regNumber')"
            (keydown)="handleInputWithSpaceTrimming($event, 'regNumber')"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <!-- <span *ngIf="isFieldInvalid('regNumber')" class="text-red-600 text-sm">Register Number is required.</span> -->
        </div>

        <!-- Updated Company Name fields for ADD section (Page One) -->
        <div class="pb-6">
          <label for="companyNameEnglish" class="block text-sm font-medium text-gray-700 dark:text-textDark">Company
            Name (in English) <span style="color: #2E2E2E">*</span></label>
          <input id="companyNameEnglish" name="companyNameEnglish" [(ngModel)]="companyData.companyNameEnglish"
            (keydown)="allowOnlyEnglish($event, companyData.companyNameEnglish || '')"
            (input)="capitalizeFirstLetter('companyNameEnglish')" (blur)="onBlur('companyNameEnglish')"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <div *ngIf="englishInputError" class="text-red-600 text-sm mt-1">
            Only English letters are allowed. Numbers and special characters are not permitted.
          </div>
          <span *ngIf="isFieldInvalid('companyNameEnglish')" class="text-red-600 text-sm">Company Name in English
            required.</span>
        </div>

        <div class="pb-6">
          <label for="companyNameSinhala" class="block text-sm font-medium text-gray-700 dark:text-textDark">Company
            Name (in Sinhala) <span style="color: #2E2E2E">*</span></label>
          <input id="companyNameSinhala" name="companyNameSinhala" [(ngModel)]="companyData.companyNameSinhala"
            (keydown)="allowOnlySinhala($event, companyData.companyNameSinhala || '')"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <div *ngIf="sinhalaInputError" class="text-red-600 text-sm mt-1">
            Only Sinhala letters are allowed. Numbers and special characters are not permitted.
          </div>
          <span *ngIf="isFieldInvalid('companyNameSinhala')" class="text-red-600 text-sm">Company Name in Sinhala
            required.</span>
        </div>

        <div class="pb-6">
          <label for="companyNameTamil" class="block text-sm font-medium text-gray-700 dark:text-textDark">Company Name
            (in Tamil) <span style="color: #2E2E2E">*</span></label>
          <input id="companyNameTamil" name="companyNameTamil" [(ngModel)]="companyData.companyNameTamil"
            (keydown)="allowOnlyTamil($event, companyData.companyNameTamil || '')"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <div *ngIf="tamilInputError" class="text-red-600 text-sm mt-1">
            Only Tamil letters are allowed. Numbers and special characters are not permitted.
          </div>
          <span *ngIf="isFieldInvalid('companyNameTamil')" class="text-red-600 text-sm">Company Name in Tamil
            required.</span>
        </div>

        <div class="pb-6">
          <label for="email" class="block text-sm font-medium text-gray-700 dark:text-textDark">Company Email
            Address <span style="color: #2E2E2E">*</span></label>
          <input id="email" name="email" [(ngModel)]="companyData.email" (blur)="onBlur('email')" type="email"
            (keydown)="handleInputWithSpaceTrimming($event, 'email')"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <span *ngIf="isFieldInvalid('email')" class="text-red-600 text-sm">Email is required.</span>
          <span *ngIf="companyData.email && !isValidEmail(companyData.email)" class="text-red-600 text-sm">
            Enter a valid email address.
          </span>
        </div>
      </div>

      <div class="flex justify-end m-10">
      <button type="button" (click)="onCancel()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md mr-2">
          Cancel
        </button>
        <button type="submit" class="px-4 py-2 bg-[#3980C0] text-white rounded-md" (click)="nextFormCreate('pageTwo')">
          Next
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="itemId === null">
    <div *ngIf="selectedPage === 'pageTwo'">
      <h2 class="text-2xl mb-6 text-textLight dark:text-textDark">
        Billing Information
      </h2>
      <div>
        <!-- Updated Account Holder Name and Account Number fields for ADD section (Page Two) -->
        <div class="pb-6">
          <label for="accHolderName" class="block text-sm font-medium text-gray-700 dark:text-textDark">Account Holder's
            Name <span style="color: #2E2E2E">*</span></label>
          <input id="accHolderName" name="accHolderName" [(ngModel)]="companyData.accHolderName"
            (keydown)="allowOnlyEnglishLettersForAccountHolder($event)"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <div *ngIf="invalidCharError" class="text-red-500 text-sm mt-1">
            Only English letters and spaces are allowed. Numbers and special characters are not permitted.
          </div>
          <span *ngIf="isFieldInvalid('accHolderName')" class="text-red-600 text-sm">Account Holder Name is
            required.</span>
        </div>

        <div class="pb-6">
          <label for="accNumber" class="block text-sm font-medium text-gray-700 dark:text-textDark">
            Account Number <span style="color: #2E2E2E">*</span>
          </label>
          <input id="accNumber" name="accNumber" [(ngModel)]="companyData.accNumber" (blur)="onBlur('accNumber')"
            (keydown)="allowOnlyDigitsForAccountNumber($event)"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <div *ngIf="accountNumberError" class="text-red-600 text-sm mt-1">
            Only digits are allowed in account number. Letters and special characters are not permitted.
          </div>
          <span *ngIf="isFieldInvalid('accNumber')" class="text-red-600 text-sm">
            Account Number is required.
          </span>
        </div>

        <div class="pb-6">
          <label for="confirmAccNumber" class="block text-sm font-medium text-gray-700 dark:text-textDark">
            Confirm Account Number <span style="color: #2E2E2E">*</span>
          </label>
          <input id="confirmAccNumber" name="confirmAccNumber" [(ngModel)]="companyData.confirmAccNumber"
            (blur)="onBlur('confirmAccNumber')" (keydown)="allowOnlyDigitsForAccountNumber($event)"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <div *ngIf="accountNumberError" class="text-red-600 text-sm mt-1">
            Only digits are allowed in account number. Letters and special characters are not permitted.
          </div>
          <span *ngIf="confirmAccountNumberRequired" class="text-red-600 text-sm">
            Confirm Account Number is required.
          </span>
          <span *ngIf="confirmAccountNumberError && !confirmAccountNumberRequired" class="text-red-600 text-sm">
            Account Numbers do not match.
          </span>
        </div>

        <div class="pb-6">
          <label for="bankDropdown" class="block text-sm font-medium text-gray-700 dark:text-textDark mb-1">
            Bank Name
          </label>
          <p-dropdown id="bankDropdown" [(ngModel)]="selectedBankId" (onChange)="onBankChange()" [options]="banks"
            optionLabel="name" optionValue="ID" [filter]="true" filterBy="name" placeholder="Select a bank"
            [showClear]="false" class="w-full" [ngClass]="{
              'p-invalid': isFieldInvalid('bankName')
            }">
          </p-dropdown>
          <!-- <span *ngIf="isFieldInvalid('bankName')" class="text-red-600 text-sm">
            Bank Name is required.
          </span> -->
        </div>

        <div class="pb-6">
          <label for="branchDropdown" class="block text-sm font-medium text-gray-700 dark:text-textDark mb-1">
            Branch Name
          </label>
          <p-dropdown id="branchDropdown" [(ngModel)]="selectedBranchId" (onChange)="onBranchChange()"
            [options]="branches" optionLabel="name" optionValue="ID" [filter]="true" filterBy="name"
            placeholder="Select a branch" [showClear]="false" [disabled]="!selectedBankId" class="w-full" [ngClass]="{
              'p-invalid': isFieldInvalid('branchName')
            }">
          </p-dropdown>
          <!-- <span *ngIf="isFieldInvalid('branchName')" class="text-red-600 text-sm">
            Branch Name is required.
          </span> -->
        </div>

        <div class="pb-6">
          <label for="foName" class="block text-sm font-medium text-gray-700 dark:text-textDark">Finance Officer’s
            Name <span style="color: #2E2E2E">*</span></label>
          <input id="foName" name="foName" [(ngModel)]="companyData.foName" (keydown)="allowOnlyEnglishLetterss($event)"
            (keydown)="handleInputWithSpaceTrimming($event, 'foName')" (input)="capitalizeFirstLetter('foName')"
            (blur)="onBlur('foName')"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <!-- <div *ngIf="invalidFoName" class="text-red-500 text-sm mt-1">
            Only English letters and spaces are allowed in Finance Officer’s Name.
          </div> -->
          <span *ngIf="isFieldInvalid('foName')" class="text-red-600 text-sm">Finance Officer’s Name is required.</span>
        </div>

        <div class="flex gap-5">
          <div class="w-1/2">
            <label for="phoneNumber01" class="block text-sm font-medium text-gray-700 dark:text-textDark">
              Company Contact Number - 1 <span style="color: #2E2E2E">*</span>
            </label>
            <div class="mt-1">
              <div class="flex">
                <p-dropdown [(ngModel)]="companyData.oicConCode1" [options]="countries" optionLabel="dialCode"
                  optionValue="dialCode"
                  styleClass="border border-gray-300 rounded-l-md bg-gray-50 mr-5 text-textLight dark:text-textDark dark:bg-tileBlack custom-dropdown flex-shrink-0"
                  [style]="{ width: '140px' }">
                  <!-- Dropdown items -->
                  <ng-template let-country pTemplate="item">
                    <div class="flex items-center gap-2">
                      <img [src]="getFlagUrl(country.code)" width="24" height="18" [alt]="country.name" />
                      <span>{{ country.dialCode }}</span>
                    </div>
                  </ng-template>

                  <!-- Selected item -->
                  <ng-template let-country pTemplate="selectedItem">
                    <div class="flex items-center gap-2" *ngIf="country">
                      <img [src]="getFlagUrl(country.code)" width="24" height="18" [alt]="country.name" />
                      <span>{{ country.dialCode }}</span>
                    </div>
                  </ng-template>
                </p-dropdown>
                <input id="phoneNumber01" name="oicConNum1" type="tel" inputmode="numeric" pattern="[0-9]*"
                  maxlength="9" required
                  class="block w-full p-2 border border-gray-300 rounded-r-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack"
                  placeholder="7XXXXXXXX" [(ngModel)]="companyData.oicConNum1" #oicConNum1Ref="ngModel"
                  (blur)="validateContactNumbers()" />
              </div>
              <!-- Error messages outside the flex container -->
              <div class="mt-1">
                <div *ngIf="contactNumberError1 && oicConNum1Ref.valid" class="text-red-500 text-sm">
                  Contact number must be exactly 9 digits.
                </div>
              </div>
            </div>
          </div>

          <div class="w-1/2">
            <label for="phoNumTwo" class="block text-sm font-medium text-gray-700 dark:text-textDark">
              Company Contact Number - 2
            </label>
               <div class="mt-1">
      <div class="flex">
        <p-dropdown [(ngModel)]="companyData.oicConCode2" [options]="countries" optionLabel="dialCode"
          optionValue="dialCode"
          styleClass="border border-gray-300 rounded-l-md bg-gray-50 mr-5 text-textLight dark:text-textDark dark:bg-tileBlack custom-dropdown flex-shrink-0"
          [style]="{ width: '140px' }">
          <!-- Dropdown items -->
          <ng-template let-country pTemplate="item">
            <div class="flex items-center gap-2">
              <img [src]="getFlagUrl(country.code)" width="24" height="18" [alt]="country.name" />
              <span>{{ country.dialCode }}</span>
            </div>
          </ng-template>

          <!-- Selected item -->
          <ng-template let-country pTemplate="selectedItem">
            <div class="flex items-center gap-2" *ngIf="country">
              <img [src]="getFlagUrl(country.code)" width="24" height="18" [alt]="country.name" />
              <span>{{ country.dialCode }}</span>
            </div>
          </ng-template>
        </p-dropdown>
        <input id="phoneNumber02" name="oicConNum2" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="9"
          (keydown)="handleInputWithSpaceTrimming($event, 'oicConNum2')"
          class="block w-full p-2 border border-gray-300 rounded-r-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack"
          placeholder="7XXXXXXXX" [(ngModel)]="companyData.oicConNum2" (blur)="validateContactNumbers()" />
      </div>
      <!-- Error messages outside the flex container -->
      <div class="mt-1">
        <div *ngIf="contactNumberError2" class="text-red-500 text-sm">
          Contact number must be exactly 9 digits.
        </div>
      </div>
            </div>
          </div>
        </div>
      </div>

      <div class="flex justify-end m-10">
        <button (click)="nextFormCreate('pageOne')" type="button"
          class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md mr-2">
          Back
        </button>
        <button type="button" (click)="saveCompanyData()" [disabled]="
            !companyData.confirmAccNumber ||
            !companyData.accNumber ||
            !companyData.accHolderName ||
            !companyData.bankName ||
            !companyData.branchName ||
            !companyData.foName ||
            companyData.accNumber != companyData.confirmAccNumber
          " class="px-4 py-2 bg-[#3980C0] text-white rounded-md">
          Submit
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="itemId !== null && !isView">
    <div *ngIf="selectedPage === 'pageOne'">
      <h2 class="text-2xl mb-6 text-textLight dark:text-textDark">
        Edit Company Details
      </h2>

      <div class="flex justify-between items-center mb-8">
        <!-- Logo Section -->
        <div class="flex items-center">
  <label class="block text-sm font-medium text-gray-700 dark:text-textDark mb-2">
    Company Logo *
  </label>
  <div class="relative ml-5">
    <label for="logoUploadEdit" class="cursor-pointer">
      <div
        class="w-20 h-20 border-2 border-[#3980C0] dark:border-gray-600 rounded-lg flex items-center justify-center bg-gray-50 dark:bg-tileBlack hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors relative"
        [ngClass]="{'border-red-500': isFieldInvalid('logo')}">
        <div *ngIf="!companyData.logo" class="text-center">
          <svg class="w-8 h-8 text-gray-400 dark:text-gray-500 mx-auto mb-1" fill="none" stroke="currentColor"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
        </div>
        <img *ngIf="companyData.logo" [src]="companyData.logo" alt="Current logo"
          class="w-full h-full object-cover rounded-lg" />
        <button *ngIf="companyData.logo" (click)="removeLogo($event)" type="button"
          class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition-colors">
          ×
        </button>
      </div>
    </label>
    <input type="file" id="logoUploadEdit" name="logoUploadEdit" accept="image/*" (change)="onLogoChange($event)"
      class="hidden" />
  </div>
  <div class="ml-3">
    <span *ngIf="isFieldInvalid('logo')" class="text-red-600 text-sm block">Logo is required.</span>
    <span *ngIf="logoSizeError" class="text-red-600 text-sm block">Image must be less than 1MB</span>
  </div>
</div>

        <!-- Favicon Section -->
        <div class="flex items-center">
  <label class="block text-sm font-medium text-gray-700 dark:text-textDark mb-2">
    Company Favicon *
  </label>
  <div class="relative ml-5">
    <label for="faviconUploadEdit" class="cursor-pointer">
      <div
        class="w-20 h-20 border-2 border-[#3980C0] dark:border-gray-600 rounded-lg flex items-center justify-center bg-gray-50 dark:bg-tileBlack hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors relative"
        [ngClass]="{'border-red-500': isFieldInvalid('favicon')}">
        <div *ngIf="!companyData.favicon" class="text-center">
          <svg class="w-8 h-8 text-gray-400 dark:text-gray-500 mx-auto mb-1" fill="none" stroke="currentColor"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
        </div>
        <img *ngIf="companyData.favicon" [src]="companyData.favicon" alt="Current favicon"
          class="w-full h-full object-cover rounded-lg" />
        <button *ngIf="companyData.favicon" (click)="removeFavicon($event)" type="button"
          class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition-colors">
          ×
        </button>
      </div>
    </label>
    <input type="file" id="faviconUploadEdit" name="faviconUploadEdit" accept="image/*,.ico" (change)="onFaviconChange($event)"
      class="hidden" />
  </div>
  <div class="ml-3">
    <span *ngIf="isFieldInvalid('favicon')" class="text-red-600 text-sm block">Favicon is required.</span>
    <span *ngIf="faviconSizeError" class="text-red-600 text-sm block">Image must be less than 1MB</span>
  </div>
</div>
      </div>

      <hr class="my-5" />

      <div>
        <div class="pb-6">
          <label for="regNumber" class="block text-sm font-medium text-gray-700 dark:text-textDark">Registration Number
            of the Company</label>
          <input [(ngModel)]="companyData.regNumber" id="regNumber" name="regNumber"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <div *ngIf="
              userForm.get('regNumber')!.invalid &&
              (userForm.get('regNumber')!.dirty ||
                userForm.get('regNumber')!.touched)
            " class="text-red-500 text-sm mt-1">
            <div *ngIf="userForm.get('regNumber')!.errors?.['required']">
              Phone number is required.
            </div>
            <div *ngIf="userForm.get('regNumber')!.errors?.['pattern']">
              Please enter a valid phone number starting with +94 followed by 9
              digits.
            </div>
          </div>
        </div>

        <div class="pb-6">
          <label for="companyNameEnglish" class="block text-sm font-medium text-gray-700 dark:text-textDark">Company
            Name (in English)</label>
          <input id="companyNameEnglish" name="companyNameEnglish" [(ngModel)]="companyData.companyNameEnglish"
            (keydown)="allowOnlyEnglish($event, companyData.companyNameEnglish || '')"
            (input)="capitalizeFirstLetter('companyNameEnglish')" (blur)="onBlur('companyNameEnglish')"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <div *ngIf="englishInputError" class="text-red-600 text-sm mt-1">
            Only English letters are allowed. Numbers and special characters are not permitted.
          </div>
          <div *ngIf="
      userForm.get('companyNameEnglish')!.invalid &&
      (userForm.get('companyNameEnglish')!.dirty ||
        userForm.get('companyNameEnglish')!.touched)
    " class="text-red-500 text-sm mt-1">
            <div *ngIf="userForm.get('companyNameEnglish')!.errors?.['required']">
              Company Name is required.
            </div>
          </div>
        </div>
        <div class="pb-6">
          <label for="companyNameSinhala" class="block text-sm font-medium text-gray-700 dark:text-textDark">Company
            Name (in Sinhala)</label>
          <input id="companyNameSinhala" name="companyNameSinhala" [(ngModel)]="companyData.companyNameSinhala"
            (keydown)="allowOnlySinhala($event, companyData.companyNameSinhala || '')"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <div *ngIf="sinhalaInputError" class="text-red-600 text-sm mt-1">
            Only Sinhala letters are allowed. Numbers and special characters are not permitted.
          </div>
          <div *ngIf="
      userForm.get('companyNameSinhala')!.invalid &&
      (userForm.get('companyNameSinhala')!.dirty ||
        userForm.get('companyNameSinhala')!.touched)
    " class="text-red-500 text-sm mt-1">
            <div *ngIf="userForm.get('companyNameSinhala')!.errors?.['required']">
              Company Name is required.
            </div>
          </div>
        </div>

        <div class="pb-6">
          <label for="companyNameTamil" class="block text-sm font-medium text-gray-700 dark:text-textDark">Company Name
            (in Tamil)</label>
          <input id="companyNameTamil" name="companyNameTamil" [(ngModel)]="companyData.companyNameTamil"
            (keydown)="allowOnlyTamil($event, companyData.companyNameTamil || '')"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <div *ngIf="tamilInputError" class="text-red-600 text-sm mt-1">
            Only Tamil letters are allowed. Numbers and special characters are not permitted.
          </div>
          <div *ngIf="
      userForm.get('companyNameTamil')!.invalid &&
      (userForm.get('companyNameTamil')!.dirty ||
        userForm.get('companyNameTamil')!.touched)
    " class="text-red-500 text-sm mt-1">
            <div *ngIf="userForm.get('companyNameTamil')!.errors?.['required']">
              Company Name is required.
            </div>
          </div>
        </div>

        <div class="pb-6">
          <label for="email" class="block text-sm font-medium text-gray-700 dark:text-textDark">Company Email
            Address</label>
          <input id="email" name="email" [(ngModel)]="companyData.email" type="email"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <div *ngIf="
              userForm.get('email')!.invalid &&
              (userForm.get('email')!.dirty || userForm.get('email')!.touched)
            " class="text-red-500 text-sm mt-1">
            <div *ngIf="userForm.get('email')!.errors?.['required']">
              Email is required.
            </div>
          </div>
        </div>

        <div class="pb-6">
          <label for="oicConNum1" class="block text-sm font-medium text-gray-700 dark:text-textDark">
            Company Contact Number - 1
          </label>
          <div class="mt-1">
            <div class="flex">
              <p-dropdown [(ngModel)]="companyData.oicConCode1" [options]="countries" optionLabel="dialCode"
                optionValue="dialCode"
                styleClass="border border-gray-300 rounded-l-md bg-gray-50 mr-5 text-textLight dark:text-textDark dark:bg-tileBlack custom-dropdown flex-shrink-0"
                [style]="{ width: '140px' }">
                <!-- Dropdown items -->
                <ng-template let-country pTemplate="item">
                  <div class="flex items-center gap-2">
                    <img [src]="getFlagUrl(country.code)" width="24" height="18" [alt]="country.name" />
                    <span>{{ country.dialCode }}</span>
                  </div>
                </ng-template>

                <!-- Selected item -->
                <ng-template let-country pTemplate="selectedItem">
                  <div class="flex items-center gap-2" *ngIf="country">
                    <img [src]="getFlagUrl(country.code)" width="24" height="18" [alt]="country.name" />
                    <span>{{ country.dialCode }}</span>
                  </div>
                </ng-template>
              </p-dropdown>
              <input id="oicConNum1" name="oicConNum1" [(ngModel)]="companyData.oicConNum1" type="tel"
                pattern="^[0-9]{9}$" required #oicConNum1="ngModel" (keydown)="allowOnlyDigitsForAccountNumber($event)"
                (blur)="validateContactNumbers()" maxlength="9"
                class="flex-1 p-2 border border-gray-300 rounded-r-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
            </div>
            <!-- Error messages outside the flex container -->
            <div class="mt-1">
              <div *ngIf="!companyData.oicConNum1" class="text-gray-500 text-sm">
                No contact number provided
              </div>
              <div *ngIf="oicConNum1.invalid && (oicConNum1.dirty || oicConNum1.touched)" class="text-red-500 text-sm">
                <div *ngIf="oicConNum1.errors?.['required']">Contact Number 1 is required.</div>
                <div *ngIf="oicConNum1.errors?.['pattern']">Please enter a valid 9-digit phone number.</div>
              </div>
              <div *ngIf="contactNumberError1" class="text-red-500 text-sm">
                Contact number must be exactly 9 digits.
              </div>
              <div *ngIf="accountNumberError" class="text-red-600 text-sm">
                Only digits are allowed. Letters and special characters are not permitted.
              </div>
            </div>
          </div>
        </div>

        <div class="pb-6">
          <label for="oicConNum2" class="block text-sm font-medium text-gray-700 dark:text-textDark">
            Company Contact Number - 2
          </label>
          <div class="mt-1">
            <div class="flex">
              <p-dropdown [(ngModel)]="companyData.oicConCode2" [options]="countries" optionLabel="dialCode"
                optionValue="dialCode"
                styleClass="border border-gray-300 rounded-l-md bg-gray-50 mr-5 text-textLight dark:text-textDark dark:bg-tileBlack custom-dropdown flex-shrink-0"
                [style]="{ width: '140px' }">
                <!-- Dropdown items -->
                <ng-template let-country pTemplate="item">
                  <div class="flex items-center gap-2">
                    <img [src]="getFlagUrl(country.code)" width="24" height="18" [alt]="country.name" />
                    <span>{{ country.dialCode }}</span>
                  </div>
                </ng-template>

                <!-- Selected item -->
                <ng-template let-country pTemplate="selectedItem">
                  <div class="flex items-center gap-2" *ngIf="country">
                    <img [src]="getFlagUrl(country.code)" width="24" height="18" [alt]="country.name" />
                    <span>{{ country.dialCode }}</span>
                  </div>
                </ng-template>
              </p-dropdown>
              <input id="oicConNum2" name="oicConNum2" [(ngModel)]="companyData.oicConNum2" type="tel"
                pattern="^[0-9]{9}$" #oicConNum2="ngModel" (keydown)="allowOnlyDigitsForAccountNumber($event)"
                (blur)="validateContactNumbers()" maxlength="9"
                class="flex-1 p-2 border border-gray-300 rounded-r-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
            </div>
            <!-- Error messages outside the flex container -->
            <div class="mt-1">
              <div *ngIf="!companyData.oicConNum2" class="text-gray-500 text-sm">
                No contact number 2 provided
              </div>
              <div *ngIf="oicConNum2.invalid && (oicConNum2.dirty || oicConNum2.touched)" class="text-red-500 text-sm">
                <div *ngIf="oicConNum2.errors?.['pattern']">Please enter a valid 9-digit phone number.</div>
              </div>
              <div *ngIf="contactNumberError2" class="text-red-500 text-sm">
                Contact number must be exactly 9 digits.
              </div>
              <div *ngIf="accountNumberError" class="text-red-600 text-sm">
                Only digits are allowed. Letters and special characters are not permitted.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="flex justify-end m-10">
        <button type="button" (click)="onCancel()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md mr-2">
          Cancel
        </button>
        <button type="submit" class="px-4 py-2 bg-[#3980C0] text-white rounded-md" (click)="nextFormCreate('pageTwo')">
          Next
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="itemId !== null && !isView">
    <div *ngIf="selectedPage === 'pageTwo'">
      <h2 class="text-2xl mb-6 text-textLight dark:text-textDark">
        Edit Billing Information
      </h2>
      <div>
        <!-- Updated Account Holder Name and Account Number fields for EDIT section (Page Two) -->
        <div class="pb-6">
          <label for="accHolderName" class="block text-sm font-medium text-gray-700 dark:text-textDark">Account
            Holder's Name</label>
          <input id="accHolderName" name="accHolderName" [(ngModel)]="companyData.accHolderName"
            (keydown)="allowOnlyEnglishLettersForAccountHolder($event)"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <div *ngIf="invalidCharError" class="text-red-500 text-sm mt-1">
            Only English letters and spaces are allowed. Numbers and special characters are not permitted.
          </div>
        </div>

        <div class="pb-6">
          <label for="accNumber" class="block text-sm font-medium text-gray-700 dark:text-textDark">
            Account Number
          </label>
          <input type="text" id="accNumber" name="accNumber" [(ngModel)]="companyData.accNumber"
            (keydown)="allowOnlyDigitsForAccountNumber($event)" (blur)="validateConfirmAccNumber()"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <div *ngIf="accountNumberError" class="text-red-600 text-sm mt-1">
            Only digits are allowed in account number. Letters and special characters are not permitted.
          </div>
          <span *ngIf="isFieldInvalid('accNumber')" class="text-red-600 text-sm">
            Account Number is required.
          </span>
        </div>

        <div class="pb-6">
          <label for="confirmAccNumber" class="block text-sm font-medium text-gray-700 dark:text-textDark">
            Confirm Account Number
          </label>
          <input type="text" id="confirmAccNumber" name="confirmAccNumber" [(ngModel)]="companyData.confirmAccNumber"
            (keydown)="allowOnlyDigitsForAccountNumber($event)" (blur)="validateConfirmAccNumber()"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <div *ngIf="accountNumberError" class="text-red-600 text-sm mt-1">
            Only digits are allowed in account number. Letters and special characters are not permitted.
          </div>
          <span *ngIf="confirmAccountNumberRequired" class="text-red-600 text-sm">
            Confirm Account Number is required.
          </span>
          <span *ngIf="confirmAccountNumberError && !confirmAccountNumberRequired" class="text-red-600 text-sm">
            Account Numbers do not match.
          </span>
        </div>

        <div class="pb-6">
          <label for="bankDropdown" class="block text-sm font-medium text-gray-700 dark:text-textDark mb-1">
            Bank Name
          </label>
          <p-dropdown id="bankDropdown" [(ngModel)]="selectedBankId" (onChange)="onBankChange()" [options]="banks"
            optionLabel="name" optionValue="ID" [filter]="true" filterBy="name" placeholder="Select a bank"
            [showClear]="false" class="w-full" [ngClass]="{
              'p-invalid': isFieldInvalid('bankName')
            }">
          </p-dropdown>
          <span *ngIf="isFieldInvalid('bankName')" class="text-red-600 text-sm">
            Bank Name is required.
          </span>
        </div>

        <div class="pb-6">
          <label for="branchDropdown" class="block text-sm font-medium text-gray-700 dark:text-textDark mb-1">
            Branch Name
          </label>
          <p-dropdown id="branchDropdown" [(ngModel)]="selectedBranchId" (onChange)="onBranchChange()"
            [options]="branches" optionLabel="name" optionValue="ID" [filter]="true" filterBy="name"
            placeholder="Select a branch" [showClear]="false" [disabled]="!selectedBankId" class="w-full" [ngClass]="{
              'p-invalid': isFieldInvalid('branchName')
            }">
          </p-dropdown>
          <span *ngIf="isFieldInvalid('branchName')" class="text-red-600 text-sm">
            Branch Name is required.
          </span>
        </div>
      </div>

      <div class="flex justify-end m-10">
        <button (click)="nextFormCreate('pageOne')" type="button"
          class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md mr-2">
          Back
        </button>
        <button type="button" (click)="updateCompanyData()" [disabled]="
            !companyData.confirmAccNumber ||
            !companyData.accNumber ||
            !companyData.accHolderName ||
            !companyData.bankName ||
            !companyData.branchName ||
            companyData.accNumber != companyData.confirmAccNumber
          " class="px-4 py-2 bg-[#3980C0] text-white rounded-md">
          Save
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="itemId !== null && isView">
    <h2 class="text-2xl mb-6 text-textLight dark:text-textDark">
      Company Details
    </h2>
    <div>
      <div class="pb-6">
        <label for="regNumber" class="block text-sm font-medium text-gray-700 dark:text-textDark">Registration Number of
          the Company</label>
        <input id="regNumber" name="regNumber" [(ngModel)]="companyData.regNumber" [disabled]="true"
          class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
      </div>

      <div class="pb-6">
        <label for="companyNameEnglish" class="block text-sm font-medium text-gray-700 dark:text-textDark">Company Name
          (in English)</label>
        <input id="companyNameEnglish" name="companyNameEnglish" [(ngModel)]="companyData.companyNameEnglish"
          (blur)="onBlur('companyNameEnglish')"
          class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
        <div class="flex items-center mt-1">
          <span *ngIf="isCheckingCompanyName" class="text-blue-600 text-sm">
            Checking company name...
          </span>
          <span *ngIf="companyNameError" class="text-red-600 text-sm">
            {{ companyNameError }}
          </span>
          <span *ngIf="isFieldInvalid('companyNameEnglish') && !companyNameError" class="text-red-600 text-sm">Company
            Name in English required.</span>
        </div>
      </div>

      <div class="pb-6">
        <label for="companyNameSinhala" class="block text-sm font-medium text-gray-700 dark:text-textDark">Company Name
          (in Sinhala)</label>
        <input id="companyNameSinhala" name="companyNameSinhala" [(ngModel)]="companyData.companyNameSinhala"
          [disabled]="true"
          class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
      </div>

      <div class="pb-6">
        <label for="companyNameTamil" class="block text-sm font-medium text-gray-700 dark:text-textDark">Company Name
          (in Tamil)</label>
        <input id="companyNameTamil" name="companyNameTamil" [(ngModel)]="companyData.companyNameTamil"
          [disabled]="true"
          class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
      </div>

      <div class="pb-6">
        <label for="email" class="block text-sm font-medium text-gray-700 dark:text-textDark">Company Email
          Address</label>
        <input id="email" name="email" [(ngModel)]="companyData.email" [disabled]="true" type="email"
          class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
      </div>

      <div class="pb-6">
        <label for="oicConNum1" class="block text-sm font-medium text-gray-700 dark:text-textDark">
          Company Contact Number - 1
        </label>
        <input id="oicConNum1" name="oicConNum1"
          [value]="companyData.oicConNum1 ? (companyData.oicConCode1 + ' ' + companyData.oicConNum1) : '-'"
          [disabled]="true" type="text"
          class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
      </div>

      <div class="pb-6" *ngIf="companyData.oicConNum2">
        <label for="oicConNum2" class="block text-sm font-medium text-gray-700 dark:text-textDark">
          Company Contact Number - 2
        </label>
        <input id="oicConNum2" name="oicConNum2"
          [value]="companyData.oicConNum2 ? (companyData.oicConCode2 + ' ' + companyData.oicConNum2) : '-'"
          [disabled]="true" type="text"
          class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
      </div>
    </div>

    <h2 class="text-2xl mt-5 mb-10 text-textLight dark:text-textDark">
      Billing Information
    </h2>
    <div>
      <div class="pb-6">
        <label for="accHolderName" class="block text-sm font-medium text-gray-700 dark:text-textDark">Account
          Holder’s Name</label>
        <input id="accHolderName" name="accHolderName" [(ngModel)]="companyData.accHolderName"
          (keydown)="allowOnlyValidNameCharacters($event)"
          class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
        <div *ngIf="invalidCharError" class="text-red-500 text-sm mt-1">
          Only English letters, spaces, apostrophes (') and hyphens (-) are allowed.
        </div>
      </div>

      <div class="pb-6">
        <label for="accNumber" class="block text-sm font-medium text-gray-700 dark:text-textDark">
          Account Number
        </label>
        <input id="accNumber" name="accNumber" [(ngModel)]="companyData.accNumber" [disabled]="true"
          class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />
      </div>

      <div class="pb-6">
        <label for="bankDropdown" class="block text-sm font-medium text-gray-700 dark:text-textDark mb-1">
          Bank Name
        </label>
        <p-dropdown id="bankDropdown" [(ngModel)]="selectedBankId" (onChange)="onBankChange()" [options]="banks"
          optionLabel="name" optionValue="ID" [filter]="true" filterBy="name" placeholder="Select a bank"
          [showClear]="true" class="w-full" [ngClass]="{
            'p-invalid': isFieldInvalid('bankName')
          }">
        </p-dropdown>
        <span *ngIf="isFieldInvalid('bankName')" class="text-red-600 text-sm">
          Bank Name is required.
        </span>
      </div>

      <div class="pb-6">
        <label for="branchDropdown" class="block text-sm font-medium text-gray-700 dark:text-textDark mb-1">
          Branch Name
        </label>
        <p-dropdown id="branchDropdown" [(ngModel)]="selectedBranchId" (onChange)="onBranchChange()"
          [options]="branches" optionLabel="name" optionValue="ID" [filter]="true" filterBy="name"
          placeholder="Select a branch" [showClear]="true" [disabled]="!selectedBankId" class="w-full" [ngClass]="{
            'p-invalid': isFieldInvalid('branchName')
          }">
        </p-dropdown>
        <span *ngIf="isFieldInvalid('branchName')" class="text-red-600 text-sm">
          Branch Name is required.
        </span>
      </div>
    </div>
  </div>
</div>