

<app-loading-spinner *ngIf="isLoading"></app-loading-spinner>

<button
  class="mb-5 text-textLight dark:text-textDark flex items-center"
  (click)="goBack()"
  aria-label="Go back"
>
  <i class="fa-solid fa-arrow-left mr-2"></i>
  Back
</button>

<div
  class="fixed-width-container overflow-x-auto scrollbar-thin scrollbar-thumb-[#8AC440] scrollbar-track-transparent scrollbar-thumb-rounded-full"
>
  <div
    class="pt-5 pr-12 pl-12 pb-5 min-w-[1400px] bg-tileLight dark:bg-tileBlack shadow-lg rounded-lg"
  >
    <div class="flex justify-between items-center mb-4">
      <h2
        class="text-[20px] md:text-[24px] font-normal text-gray-900 dark:text-gray-100"
      >
        Complaint List ({{ totalItems }})
      </h2>
      <div class="flex items-center space-x-3">
        <!-- Reply Status -->
        <p-dropdown
          styleClass="border border-2 rounded-xl h-8 items-center bg-[#F1F1F1] dark:bg-[#272F45] text-textLight dark:text-textDark border-gray-300 dark:border-[#AFAFAF]"
          [options]="replyStatus"
          [(ngModel)]="rpst"
          optionLabel="label"
          optionValue="value"
          [showClear]="true"
          placeholder="Reply Status"
          (onChange)="regStatusFil()"
        ></p-dropdown>

        <!-- Category -->
        <p-dropdown
         styleClass="border border-2 rounded-xl h-8 items-center bg-[#F1F1F1] dark:bg-[#272F45] text-textLight dark:text-textDark border-gray-300 dark:border-[#AFAFAF]"
          [options]="comCategories"
          [(ngModel)]="filterComCategory"
          optionLabel="label"
          optionValue="value"
          [showClear]="true"
          placeholder="Category"
          (onChange)="applyFilters()"
        ></p-dropdown>

        <!-- Status -->
        <p-dropdown
          styleClass="border border-2 rounded-xl h-8 items-center bg-[#F1F1F1] dark:bg-[#272F45] text-textLight dark:text-textDark border-gray-300 dark:border-[#AFAFAF]"
          [options]="status"
          [(ngModel)]="filterStatus"
          optionLabel="label"
          optionValue="value"
          [showClear]="true"
          placeholder="Status"
          (onChange)="applyFilters()"
        ></p-dropdown>

       <!-- Search -->
        <div
          class="flex items-center rounded-full px-2 py-1 w-96 bg-gray-100 dark:bg-gray-800"
        >
       <input
    type="text"
    placeholder="Search by RefNo, Category, Name or Phone..."
    [(ngModel)]="searchText"
    (keyup.enter)="searchComplain()"
    (ngModelChange)="onSearchTextChange($event)"
    class="bg-transparent outline-none w-full text-gray-900 dark:text-gray-100"
  />
  <button
    type="button"
    (click)="searchComplain()"
    aria-label="Search"
    class="text-gray-500 hover:text-gray-700 focus:outline-none mr-1"
  >
            <!-- magnifying-glass SVG -->
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
          </button>
          <button
            type="button"
            class="text-gray-500 hover:text-gray-700 focus:outline-none"
            (click)="clearSearch()"
            aria-label="Clear search"
          >
            <!-- X-icon SVG -->
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="!filteredComplaints.length" class="text-center py-6">
      <p class="text-gray-900 dark:text-gray-100 text-lg">
        No data to display
      </p>
    </div>

    <div class="overflow-x-auto">
      <table
        class="min-w-full divide-y divide-gray-200 mt-6 dark:divide-[#4B555A] table-auto"
      >
        <thead class="bg-white dark:bg-gray-800">
          <tr>
            <th class="py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">Ref No</th>
            <th class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">Category</th>
            <th class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">First Name</th>
            <th class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">Last Name</th>
            <th class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">Contact Number</th>
            <th class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">Received At</th>
            <th class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">Status</th>
            <th class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">View</th>
            <th class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">Reply</th>
            <th class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">View Reply</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="
              let item of
                filteredComplaints
                | paginate: {
                    itemsPerPage: itemsPerPage,
                    currentPage: page,
                    id: 'retailComplaintsPager'
                  }
            "
            class="text-gray-900 dark:text-gray-100"
          >
            <td class="py-3 text-[14px] md:text-[16px] font-normal text-center whitespace-nowrap">
              {{ item.refNo }}
            </td>
            <td class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-center">
              {{ item.complainCategory }}
            </td>
            <td class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-center">
              {{ item.firstName }}
            </td>
            <td class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-center">
              {{ item.lastName }}
            </td>
            <td class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-center">
              {{ item.contactNumber }}
            </td>
         <td class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-center text-gray-900 dark:text-gray-100 whitespace-nowrap">
  {{ item.createdAt | date: 'yyyy/MM/dd' : 'UTC' }}<br>
  {{ item.createdAt | date: 'hh.mm a' : 'UTC' }}
</td>

            <td class="px-4 py-3 text-center">
              <span
                class="w-32 h-8 inline-block font-medium rounded-md px-3 py-1 text-sm"
                [ngClass]="{
                  'bg-green-100 text-green-600': item.status === 'Assigned',
                  'bg-red-100 text-red-600': item.status === 'Pending',
                  'bg-yellow-100 text-yellow-600': item.status === 'Closed'
                }"
                [ngStyle]="{
                  'color': item.status==='Assigned'? '#308233':
                           item.status==='Pending'? '#D16D6A':
                           item.status==='Closed'? '#A8A100':'',
                  'background-color': item.status==='Assigned'? '#BBFFC6':
                                      item.status==='Pending'? '#FFB9B7':
                                      item.status==='Closed'? '#F8FFA6':''
                }"
              >
                {{ item.status }}
              </span>
            </td>
            <td class="px-3 py-2 whitespace-nowrap text-center">
              <button
                (click)="navigateSelectComplain(item.id)"
                class="text-blue-600 hover:text-blue-900"
                aria-label="View complaint details"
              >
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                >
                  <path
                    d="M3 14C3 9.02944 7.02944 5 12 5C16.9706 5 21 9.02944 21 14M17 14C17 16.7614 14.7614 19 12 19C9.23858 19 7 16.7614 7 14C7 11.2386 9.23858 9 12 9C14.7614 9 17 11.2386 17 14Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
            </td>
            <td class="px-4 py-3 text-center">
              <span *ngIf="!item.reply">No</span>
              <span *ngIf="item.reply">Yes</span>
            </td>
            <td class="px-3 py-2 whitespace-nowrap text-center">
              <button
                (click)="item.reply && showReplyDialog(item)"
                [disabled]="!item.reply"
                [ngClass]="{'opacity-40 cursor-not-allowed': !item.reply}"
                class="text-blue-600 hover:text-blue-900"
                aria-label="View complaint reply"
              >
                <i class="fa-solid fa-file-export"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <pagination-controls
      [id]="'retailComplaintsPager'"
      (pageChange)="onPageChange($event)"
      previousLabel="Previous"
      nextLabel="Next"
    ></pagination-controls>
  </div>
</div>

<p-dialog
  header="Reply to Complaint"
  [(visible)]="display"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '600px' }"
  [contentStyle]="{ padding: '1rem' }"
>
  <div class="dialog-content text-left">
    <p>
      Dear <strong>{{ selectedComplaint.firstName }}</strong>,
    </p>
    <textarea
      [(ngModel)]="messageContent"
      placeholder="Add your message here..."
      rows="5"
      class="w-full p-2 border rounded mt-3 mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
      aria-label="Reply message"
    ></textarea>
    <p>
      If you have any further concerns or questions, feel free to reach
      out. Thank you for your patience and understanding.
    </p>
    <p>Sincerely,<br />Retail Support Team</p>
  </div>
  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="Cancel"
      class="p-button-secondary mr-2"
      (click)="hideDialog()"
    ></button>
    <button
      pButton
      type="button"
      label="Send"
      class="p-button-primary"
      (click)="submitReply()"
    ></button>
  </ng-template>
</p-dialog>