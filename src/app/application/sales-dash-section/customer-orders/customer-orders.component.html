<app-loading-spinner *ngIf="isLoading"></app-loading-spinner>

<button class="mb-5 text-textLight dark:text-textDark" (click)="back()">
    <i class="fa-solid fa-arrow-left"></i>
    Back
</button>

<div
    class="fixed-width-container overflow-x-auto scrollbar-thin scrollbar-thumb-scrollBarColor scrollbar-track-transparent scrollbar-thumb-rounded-full">
    <div class="pt-5 pb-5 min-w-max bg-white dark:bg-tileBlack shadow-lg rounded-lg">
        <div class="flex space-x-4 pb-5 pr-12 pl-12 border-b border-gray-300">
            <button
                *ngIf="permissionService.hasPermission('Dash customers order assigned tab') || tokenService.getUserDetails().role === '1'"
                [ngClass]="
          activeButton === 'assigned'
            ? 'border border-[#415CFF] text-[#415CFF]'
            : 'border border-gray-300 text-textLight dark:text-textDark'
        " class="h-10 px-5 inline-flex items-center justify-center rounded-full gap-2 whitespace-nowrap text-sm select-none hover:bg-gray-50 dark:hover:bg-[#2B2B2B] transition-colors"
                (click)="onStatusChange('assigned')">
                <i *ngIf="activeButton === 'assigned'" class="fa fa-check"></i>
                Assigned
            </button>
            <button
                *ngIf="permissionService.hasPermission('Dash customers order processing tab') || tokenService.getUserDetails().role === '1'"
                [ngClass]="
          activeButton === 'processing'
            ? 'border border-[#415CFF] text-[#415CFF]'
            : 'border border-gray-300 text-textLight dark:text-textDark'
        " class="h-10 px-5 inline-flex items-center justify-center rounded-full gap-2 whitespace-nowrap text-sm select-none hover:bg-gray-50 dark:hover:bg-[#2B2B2B] transition-colors"
                (click)="onStatusChange('processing')">
                <i *ngIf="activeButton === 'processing'" class="fa fa-check"></i>
                Processing
            </button>
            <button
                *ngIf="permissionService.hasPermission('Dash customers order out for outForDelivery tab') || tokenService.getUserDetails().role === '1'"
                [ngClass]="
          activeButton === 'outForDelivery'
            ? 'border border-[#415CFF] text-[#415CFF]'
            : 'border border-gray-300 text-textLight dark:text-textDark'
        " class="h-10 px-5 inline-flex items-center justify-center rounded-full gap-2 whitespace-nowrap text-sm select-none hover:bg-gray-50 dark:hover:bg-[#2B2B2B] transition-colors"
                (click)="onStatusChange('outForDelivery')">
                <i *ngIf="activeButton === 'outForDelivery'" class="fa fa-check"></i>
                Out For Delivery
            </button>
            <button
                *ngIf="permissionService.hasPermission('Dash customers order ready to ReadyToPickup tab') || tokenService.getUserDetails().role === '1'"
                [ngClass]="
          activeButton === 'readyToPickup'
            ? 'border border-[#415CFF] text-[#415CFF]'
            : 'border border-gray-300 text-textLight dark:text-textDark'
        " class="h-10 px-5 inline-flex items-center justify-center rounded-full gap-2 whitespace-nowrap text-sm select-none hover:bg-gray-50 dark:hover:bg-[#2B2B2B] transition-colors"
                (click)="onStatusChange('readyToPickup')">
                <i *ngIf="activeButton === 'readyToPickup'" class="fa fa-check"></i>
                Ready to Pickup
            </button>
            <button
                *ngIf="permissionService.hasPermission('Dash customers order pickedUp tab') || tokenService.getUserDetails().role === '1'"
                [ngClass]="
          activeButton === 'pickedUp'
            ? 'border border-[#415CFF] text-[#415CFF]'
            : 'border border-gray-300 text-textLight dark:text-textDark'
        " class="h-10 px-5 inline-flex items-center justify-center rounded-full gap-2 whitespace-nowrap text-sm select-none hover:bg-gray-50 dark:hover:bg-[#2B2B2B] transition-colors"
                (click)="onStatusChange('pickedUp')">
                <i *ngIf="activeButton === 'pickedUp'" class="fa fa-check"></i>
                Picked up
            </button>
            <button
                *ngIf="permissionService.hasPermission('Dash customers order collected tab') || tokenService.getUserDetails().role === '1'"
                [ngClass]="
          activeButton === 'collected'
            ? 'border border-[#415CFF] text-[#415CFF]'
            : 'border border-gray-300 text-textLight dark:text-textDark'
        " class="h-10 px-5 inline-flex items-center justify-center rounded-full gap-2 whitespace-nowrap text-sm select-none hover:bg-gray-50 dark:hover:bg-[#2B2B2B] transition-colors"
                (click)="onStatusChange('collected')">
                <i *ngIf="activeButton === 'collected'" class="fa fa-check"></i>
                Collected
            </button>
            <button
                *ngIf="permissionService.hasPermission('Dash customers order ontheway tab') || tokenService.getUserDetails().role === '1'"
                [ngClass]="
          activeButton === 'ontheway'
            ? 'border border-[#415CFF] text-[#415CFF]'
            : 'border border-gray-300 text-textLight dark:text-textDark'
        " class="h-10 px-5 inline-flex items-center justify-center rounded-full gap-2 whitespace-nowrap text-sm select-none hover:bg-gray-50 dark:hover:bg-[#2B2B2B] transition-colors"
                (click)="onStatusChange('ontheway')">
                <i *ngIf="activeButton === 'ontheway'" class="fa fa-check"></i>
                On the way
            </button>
            <button
                *ngIf="permissionService.hasPermission('Dash customers order delivered tab') || tokenService.getUserDetails().role === '1'"
                [ngClass]="
          activeButton === 'delivered'
            ? 'border border-[#415CFF] text-[#415CFF]'
            : 'border border-gray-300 text-textLight dark:text-textDark'
        " class="h-10 px-5 inline-flex items-center justify-center rounded-full gap-2 whitespace-nowrap text-sm select-none hover:bg-gray-50 dark:hover:bg-[#2B2B2B] transition-colors"
                (click)="onStatusChange('delivered')">
                <i *ngIf="activeButton === 'delivered'" class="fa fa-check"></i>
                Delivered
            </button>
            <button
                *ngIf="permissionService.hasPermission('Dash customers order hold tab') || tokenService.getUserDetails().role === '1'"
                [ngClass]="
          activeButton === 'hold'
            ? 'border border-[#415CFF] text-[#415CFF]'
            : 'border border-gray-300 text-textLight dark:text-textDark'
        " class="h-10 px-5 inline-flex items-center justify-center rounded-full gap-2 whitespace-nowrap text-sm select-none hover:bg-gray-50 dark:hover:bg-[#2B2B2B] transition-colors"
                (click)="onStatusChange('hold')">
                <i *ngIf="activeButton === 'hold'" class="fa fa-check"></i>
                Hold
            </button>
            <button
                *ngIf="permissionService.hasPermission('Dash customers order return tab') || tokenService.getUserDetails().role === '1'"
                [ngClass]="
          activeButton === 'return'
            ? 'border border-[#415CFF] text-[#415CFF]'
            : 'border border-gray-300 text-textLight dark:text-textDark'
        " class="h-10 px-5 inline-flex items-center justify-center rounded-full gap-2 whitespace-nowrap text-sm select-none hover:bg-gray-50 dark:hover:bg-[#2B2B2B] transition-colors"
                (click)="onStatusChange('return')">
                <i *ngIf="activeButton === 'return'" class="fa fa-check"></i>
                Return
            </button>
            <button
                *ngIf="permissionService.hasPermission('Dash customers order Return Received tab') || tokenService.getUserDetails().role === '1'"
                [ngClass]="
          activeButton === 'returnReceived'
            ? 'border border-[#415CFF] text-[#415CFF]'
            : 'border border-gray-300 text-textLight dark:text-textDark'
        " class="h-10 px-5 inline-flex items-center justify-center rounded-full gap-2 whitespace-nowrap text-sm select-none hover:bg-gray-50 dark:hover:bg-[#2B2B2B] transition-colors"
                (click)="onStatusChange('returnReceived')">
                <i *ngIf="activeButton === 'returnReceived'" class="fa fa-check"></i>
                Return Received
            </button>
            <button
                *ngIf="permissionService.hasPermission('Dash customers order cancelled tab') || tokenService.getUserDetails().role === '1'"
                [ngClass]="
          activeButton === 'cancelled'
            ? 'border border-[#415CFF] text-[#415CFF]'
            : 'border border-gray-300 text-textLight dark:text-textDark'
        " class="h-10 px-5 inline-flex items-center justify-center rounded-full gap-2 whitespace-nowrap text-sm select-none hover:bg-gray-50 dark:hover:bg-[#2B2B2B] transition-colors"
                (click)="onStatusChange('cancelled')">
                <i *ngIf="activeButton === 'cancelled'" class="fa fa-check"></i>
                Cancelled
            </button>
        </div>

        <div class="h-5"></div>

        <!-- Loading indicator -->
        <div *ngIf="isLoading" class="flex justify-center p-8">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-[#415CFF]"></div>
        </div>

        <div *ngIf="!hasData" class="flex flex-col items-center w-full h-screen px-10 py-7 mt-6 ">
            <p class="text-[#494949] my-6 dark:text-textDark">--No Data Available--</p>
            <img src="assets/images/NoData.png" alt="No Data" class="w-20 h-20" />
        </div>

        <div class="px-5"
            *ngIf="!isLoading && !errorMessage && hasData && permissionService.hasPermission('Dash customers order') || tokenService.getUserDetails().role === '1'">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-[#4B555A] table-auto">
                <thead>
                    <tr>
                        <th class="px-3 py-3 font-normal text-textLight dark:text-textDark text-left">
                            Invoice No
                        </th>
                        <th class="px-3 py-3 font-normal text-textLight dark:text-textDark text-left">
                            Order Type
                        </th>
                        <th class="px-3 py-3 font-normal text-textLight dark:text-textDark text-center">
                            Order Time
                        </th>
                        <th class="px-3 py-3 font-normal text-textLight dark:text-textDark text-left">
                            Schedule
                        </th>
                        <th class="px-3 py-3 font-normal text-textLight dark:text-textDark text-left">
                            Payment
                        </th>
                        <th class="px-3 py-3 font-normal text-textLight dark:text-textDark text-center">
                            Payment Status
                        </th>
                        <th class="px-3 py-3 font-normal text-textLight dark:text-textDark text-center">
                            Amount
                        </th>
                        <th class="px-3 py-3 font-normal text-textLight dark:text-textDark text-center">
                            Order Status
                        </th>
                        <!-- PRE-INVOICE Column -->
                        <th *ngIf="permissionService.hasPermission('Dash customers order download invoice') || tokenService.getUserDetails().role === '1'"
                            class="px-3 py-3 font-normal text-textLight dark:text-textDark text-center">
                            PRE-INVOICE
                        </th>
                        <!-- POST-INVOICE Column -->
                        <th *ngIf="permissionService.hasPermission('Dash customers order download invoice') || tokenService.getUserDetails().role === '1'"
                            class="px-3 py-3 font-normal text-textLight dark:text-textDark text-center">
                            POST-INVOICE
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <ng-container *ngIf="orders && orders.length > 0; else noData">
                        <tr *ngFor="let order of orders" class="border-b border-gray-200 dark:border-[#4B555A]">
                            <td class="px-3 py-3 text-left dark:text-textDark">{{ order.invNo }}</td>
                            <td class="px-3 py-3 text-left dark:text-textDark">
                                <span *ngIf="order.isPackage === 1">Package</span>
                                <span *ngIf="order.isPackage === 0">Custom</span>
                            </td>
                            <td class="px-3 py-3 text-center dark:text-textDark">
                                {{ order.sheduleDate | date : "d MMM, y h:mm a" }}
                            </td>
                            <td class="px-3 py-3 text-left dark:text-textDark">{{ order.sheduleType }}</td>
                            <td class="px-3 py-3 text-left dark:text-textDark">{{ order.paymentMethod === 'Card' ? 'Debit/Credit' : 'Cash on Delivery' }}</td>
                            <td class="px-3 py-3 text-center">
                                <span [ngClass]="getPaymentStatusClass(order.paymentMethod, order.isPaid)">
                                    {{ getPaymentStatusText(order.paymentMethod, order.isPaid) }}
                                </span>
                            </td>
                            <td class="px-3 py-3 text-center dark:text-textDark">
                                {{ order.fullTotal | number : "1.2-2" }}
                            </td>
                            <td class="px-3 py-3 text-center">
                                <span *ngIf="activeButton === 'assigned'"
                                    class="bg-[#F5FF85] text-[#878216] rounded-xl px-5 py-2">
                                    Assigned
                                </span>
                                <span *ngIf="activeButton === 'processing'"
                                    class="bg-[#CFE1FF] text-[#3B82F6] rounded-xl px-5 py-2">
                                    Processing
                                </span>
                                <span *ngIf="activeButton === 'outForDelivery'"
                                    class="bg-[#FCD4FF] text-[#80118A] rounded-xl px-5 py-2">
                                    Out For Delivery
                                </span>
                                <span *ngIf="activeButton === 'readyToPickup'"
                                    class="bg-[#ACFBFF] text-[#00818A] rounded-xl px-5 py-2">
                                    Ready to Pickup
                                </span>
                                <span *ngIf="activeButton === 'pickedUp'"
                                    class="bg-[#BBFFC6] text-[#308233] rounded-xl px-5 py-2">
                                    Picked up
                                </span>
                                <span *ngIf="activeButton === 'collected'"
                                    class="bg-[#F8FEA5] text-[#7E8700] rounded-xl px-5 py-2">
                                    Collected
                                </span>
                                <span *ngIf="activeButton === 'ontheway'"
                                    class="bg-[#FFEDCF] text-[#D17A00] rounded-xl px-5 py-2">
                                    On the way
                                </span>
                                <span *ngIf="activeButton === 'delivered'"
                                    class="bg-[#BBFFC6] text-[#308233] rounded-xl px-5 py-2">
                                    Delivered
                                </span>
                                <span *ngIf="activeButton === 'hold'"
                                    class="bg-[#FFEDCF] text-[#D17A00] rounded-xl px-5 py-2">
                                    Hold
                                </span>
                                <span *ngIf="activeButton === 'return'"
                                    class="bg-[#FFDCDA] text-[#FF1100] rounded-xl px-5 py-2">
                                    Return
                                </span>
                                <span *ngIf="activeButton === 'returnReceived'"
                                    class="bg-[#FFDCDA] text-[#FF1100] rounded-xl px-5 py-2">
                                    Return Received
                                </span>
                                <span *ngIf="activeButton === 'cancelled'"
                                    class="bg-[#DFDFDF] text-[#5C5C5C] rounded-xl px-5 py-2">
                                    Cancelled
                                </span>
                            </td>

                            <!-- PRE-INVOICE Column Data Cell -->
                            <td *ngIf="permissionService.hasPermission('Dash customers order download invoice') || tokenService.getUserDetails().role === '1'"
                                class="px-3 py-3 text-center">
                                <button
                                    class="text-textLight dark:text-textDark hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                                    (click)="downloadInvoice(order.id, order.invNo)" title="Download Pre-Invoice">
                                    <i class="fa-solid fa-file-invoice text-xl"></i>
                                </button>
                            </td>

                            <!-- POST-INVOICE Column Data Cell -->
                            <td *ngIf="permissionService.hasPermission('Dash customers order download invoice') || tokenService.getUserDetails().role === '1'"
                                class="px-3 py-3 text-center">
                                <div class="relative inline-block">
                                    <button class="flex justify-center gap-1 transition-colors" [ngClass]="{
                            'text-textLight dark:text-textDark hover:text-green-600 dark:hover:text-green-400 cursor-pointer': isPostInvoiceEnabled(order.status),
                            'text-gray-400 dark:text-gray-600 cursor-not-allowed': !isPostInvoiceEnabled(order.status)
                        }" [disabled]="!isPostInvoiceEnabled(order.status)"
                                        (click)="isPostInvoiceEnabled(order.status) ? downloadPostInvoice(order.id, order.invNo) : null"
                                        title="Download Post-Invoice">
                                        <i class="fa-solid fa-file-invoice text-xl text-center"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </ng-container>

                    <ng-template #noData>
                        <!-- Update colspan to account for both invoice columns -->
                        <tr>
                            <td [attr.colspan]="(permissionService.hasPermission('Dash customers order download invoice') || tokenService.getUserDetails().role === '1') ? 10 : 8"
                                class="px-3 py-16 text-center">
                                <div class="flex flex-col items-center justify-center space-y-3">
                                    <i class="fa-solid fa-box-open text-5xl text-gray-400 dark:text-gray-500"></i>
                                    <p class="text-lg font-medium text-textLight dark:text-textDark">
                                        No orders available
                                    </p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">
                                        There are no orders for the selected status
                                    </p>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </tbody>
            </table>
        </div>
    </div>
</div>