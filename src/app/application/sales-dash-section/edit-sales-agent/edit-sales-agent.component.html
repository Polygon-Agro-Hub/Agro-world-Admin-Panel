<div *ngIf="isLoading">
  <app-loading-spinner></app-loading-spinner>
</div>

<button (click)="back()" class="text-textLight dark:text-textDark">
  <i class="fa-solid fa-arrow-left"></i>
  Back
</button>
<div class="h-[20px]"></div>
<div class="mx-auto p-6 bg-white dark:bg-tileBlack rounded-lg shadow-mg">
  <div>
    <!-- <div> -->
    <h2 class="text-2xl mb-4 text-textLight dark:text-textDark">
      Edit Sales Agent's Details
    </h2>
    <div>
      <div class="flex justify-center pt-3 pb-9">
        <div class="relative">
          <input type="file" id="imageUpload" accept="image/*" class="hidden" (change)="onFileSelected($event)" />

          <!-- Display default image if no file is selected -->
          <img *ngIf="!selectedImage && personalData.image" class="rounded-full w-60 h-60 object-cover"
            [src]="personalData.image" alt="Profile Picture" />

          <img *ngIf="!personalData.image && !selectedImage" class="rounded-full w-60 h-60 object-cover" [src]="
              'https://img.freepik.com/premium-vector/default-avatar-profile-icon-social-media-user-image-gray-avatar-icon-blank-profile-silhouette-vector-illustration_561158-3407.jpg?w=360'
            " alt="Profile Picture" />

          <!-- Display the selected image if available -->
          <img *ngIf="selectedImage" class="rounded-full w-60 h-60 object-cover" [src]="selectedImage"
            alt="Profile Picture" />

          <!-- <span (click)="triggerFileInput($event)"
              class="absolute bottom-5 right-5 transform translate-x-1/4 translate-y-1/4 bg-white p-1 rounded-full cursor-pointer">
              <img src="../../../../assets/images/editIcon.png" alt="Edit Icon" class="w-16 h-16" />
            </span> -->
          <span (click)="triggerFileInput($event)"
            class="absolute bottom-5 right-5 transform translate-x-1/4 translate-y-1/4 bg-[#3980C0] w-12 h-12 flex items-center justify-center rounded-full cursor-pointer">
            <i class="fa-solid fa-pen text-lg text-white"></i>
          </span>
        </div>
      </div>

      <div class="h-[20px]"></div>
      <div>
        <label for="enpType" class="block text-sm font-medium text-gray-700 dark:text-textDark">
          Staff Employee Type <span class="text-[#2E2E2E]">*</span>
        </label>

        <div class="flex items-center space-x-4 mt-3">
          <div class="flex items-center space-x-2">
            <input class="w-5 h-5" type="radio" id="permanent" name="empType" [value]="'Permanent'"
              [(ngModel)]="empType" #empTypeInput="ngModel" (ngModelChange)="updateEmployeeType($event)" required />
            <label for="permanent" class="block text-sm font-medium text-gray-700 dark:text-textDark">
              Permanent
            </label>
          </div>
          <div class="flex items-center space-x-2">
            <input class="w-5 h-5" type="radio" id="temporary" name="empType" [value]="'Temporary'"
              [(ngModel)]="empType" (ngModelChange)="updateEmployeeType($event)" required />
            <label for="temporary" class="block text-sm font-medium text-gray-700 dark:text-textDark">
              Temporary
            </label>
          </div>
        </div>

        <div *ngIf="empTypeInput.touched && !empType" class="text-red-500 text-sm mt-1">
          <div>Employee Type is required</div>
        </div>
        <div *ngIf="empTypeInput.touched && !empType" class="text-red-500 text-sm mt-1">
          <div>Employee Type is required</div>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 mt-3">
        <div>
          <label for="firstName" class="block text-sm font-medium text-gray-700 dark:text-textDark">First Name <span
              class="text-[#2E2E2E]">*</span></label>
          <input id="firstName" [(ngModel)]="personalData.firstName" name="firstName"
            class="form-control mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack"
            #firstNameInput="ngModel" (keydown)="validateNameInput($event)" (input)="capitalizeFirstLetter('firstName')"
            required />
          <div *ngIf="firstNameInput.touched && !personalData.firstName" class="text-red-500 text-sm mt-1">
            <div>First Name is required</div>
          </div>
        </div>

        <div>
          <label for="variety" class="block text-sm font-medium text-gray-700 dark:text-textDark">Last Name <span
              class="text-[#2E2E2E]">*</span></label>
          <input id="lastName" name="lastName" [(ngModel)]="personalData.lastName"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack"
            #lastNameInput="ngModel" (keydown)="validateNameInput($event)" (input)="capitalizeFirstLetter('lastName')"
            required />
          <div *ngIf="lastNameInput.touched && !personalData.lastName" class="text-red-500 text-sm mt-1">
            <div>Last Name is required</div>
          </div>
        </div>


        <!-- <div class="mb-4 w-full">
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-textDark"
              >EMP ID / User name</label
            >
            <div class="flex mt-1">
              <span
                class="inline-flex items-center px-3 py-3 text-sm text-gray-900 bg-gray-200 border border-e-0 border-gray-300 rounded-s-md dark:bg-gray-600 dark:text-gray-400 dark:border-gray-600"
              >
                <p>SA</p>
              </span>
              <input
                type="text"
                [value]="lastID"
                name="empId"
                class="rounded-none rounded-e-lg bg-gray-50 border border-gray-300 text-gray-900 focus:ring-blue-500 focus:border-blue-500 block flex-1 min-w-0 w-full text-sm pl-4 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                disabled
              />
            </div>
          </div>
        </div> -->

        <div>
          <label for="phoneNumber1" class="block text-sm font-medium text-gray-700 dark:text-textDark">
            Mobile Number - 1 <span class="text-[#2E2E2E]">*</span>
          </label>
          <div class="mt-1 flex">
            <select id="phoneNumber1Code" name="phoneNumber1Code" [(ngModel)]="personalData.phoneCode1"
              class="block p-2 border border-gray-300 rounded-l-md bg-gray-50 mr-5 text-textLight dark:text-textDark dark:bg-tileBlack">
              <option value="+94">+94 (LK)</option>
              <option value="+1">+1 (US)</option>
              <option value="+44">+44 (UK)</option>
              <option value="+91">+91 (India)</option>
            </select>
            <input id="phoneNumber1" name="phoneNumber1" type="text" [(ngModel)]="personalData.phoneNumber1"
              class="block w-full p-2 border border-gray-300 rounded-r-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack"
              placeholder="7XXXXXXXX" #phoneNumber1Input="ngModel" required minlength="9" maxlength="9"
              (keypress)="allowOnlyNumbers($event)" pattern="^7\d{8}$" />
          </div>

          <!-- Required Validation -->
          <div *ngIf="phoneNumber1Input.touched && !personalData.phoneNumber1" class="text-red-500 text-sm mt-1">
            <div>Mobile Number - 1 is required</div>
          </div>

          <!-- Pattern Validation (Ensuring Only Numbers) -->
          <div *ngIf="
              phoneNumber1Input.touched &&
              personalData.phoneNumber1 &&
              phoneNumber1Input.invalid
            " class="text-red-500 text-sm mt-1">
            Please enter a valid mobile number (format: +947XXXXXXXX)
          </div>
        </div>

        <div>
          <label for="phoNumTwo" class="block text-sm font-medium text-gray-700 dark:text-textDark">
            Mobile Number - 2
          </label>
          <div class="mt-1 flex">
            <select id="phoneNumber02Code" name="phoneNumber02Code" [(ngModel)]="personalData.phoneCode2"
              class="block p-2 border border-gray-300 rounded-l-md bg-gray-50 mr-5 text-textLight dark:text-textDark dark:bg-tileBlack">
              <option value="+94">+94 (LK)</option>
              <option value="+1">+1 (US)</option>
              <option value="+44">+44 (UK)</option>
              <option value="+91">+91 (India)</option>
            </select>
            <input id="phoneNumber2" name="phoneNumber2" type="text" [(ngModel)]="personalData.phoneNumber2"
              class="block w-full p-2 border border-gray-300 rounded-r-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack"
              placeholder="Enter your mobile number" #phoneNumber2Input="ngModel" minlength="9" maxlength="9"
              (keypress)="allowOnlyNumbers($event)" pattern="^7\d{8}$" />
          </div>

          <!-- Length Validation -->
          <div *ngIf="
              phoneNumber2Input.touched &&
              personalData.phoneNumber2 &&
              phoneNumber2Input.invalid
            " class="text-red-500 text-sm mt-1">
            Please enter a valid mobile number (format: +947XXXXXXXX)
          </div>

          <!-- Duplicate Validation -->
          <div *ngIf="
              phoneNumber2Input.touched &&
              personalData.phoneNumber1 &&
              !phoneNumber2Input.invalid &&
              personalData.phoneNumber2?.trim() ===
                personalData.phoneNumber1?.trim()
            " class="text-red-500 text-sm mt-1">
            <div>Mobile Number 2 cannot be the same as Mobile Number 1.</div>
          </div>
        </div>

        <div>
          <label for="nic" class="block text-sm font-medium text-gray-700 dark:text-textDark">NIC Number <span
              class="text-[#2E2E2E]">*</span></label>
          <input id="nic" name="nic" [(ngModel)]="personalData.nic"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack"
            #nicInput="ngModel" required (keydown)="validateNICInput($event)" (input)="formatNIC()" />

          <!-- Required Validation -->
          <div *ngIf="nicInput.touched && !personalData.nic" class="text-red-500 text-sm mt-1">
            <div>NIC Number is required</div>
          </div>

          <!-- Pattern Validation -->
          <div *ngIf="nicInput.touched && nicInput.errors?.['pattern'] || nicError" class="text-red-500 text-sm mt-1">
  Please enter a valid NIC number (12 digits or 10 digits followed by 'V').
</div>
        </div>

        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 dark:text-textDark">Email <span
              class="text-[#2E2E2E]">*</span></label>
          <input type="email" id="email" name="email" [(ngModel)]="personalData.email"
            (keydown)="validateEmailInput($event, 'email')" (input)="validateEmailOnInput()"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack"
            #emailInput="ngModel" required />

          <div *ngIf="emailInput.touched && !personalData.email" class="text-red-500 text-sm mt-1">
            <div>Email is required</div>
          </div>

          <div *ngIf="emailInput.touched && personalData.email && !isValidEmail(personalData.email)"
            class="text-red-600 text-sm">
            Please enter a valid email format ( example{{ '@' }}domain.com).
            <br>• No consecutive dots allowed
            <br>• Cannot start or end with dots
            <br>• Only letters, numbers, dots, hyphens, and underscores allowed
          </div>
        </div>
      </div>
    </div>
  </div>


  <div>
    <!-- <div> -->
    <h2 class="text-2xl mb-6 mt-10 text-textLight dark:text-textDark">
      Residential Details
    </h2>
    <div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div class="pb-6">
          <label for="house" class="block text-sm font-medium text-gray-700 dark:text-textDark">House / Plot Number
            <span class="text-[#2E2E2E]">*</span></label>
          <input id="houseNumber" name="houseNumber" [(ngModel)]="personalData.houseNumber"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack"
            #houseNumberInput="ngModel" required />
          <div *ngIf="houseNumberInput.touched && !personalData.houseNumber" class="text-red-500 text-sm mt-1">
            <div>House number is required</div>
          </div>
        </div>

        <div class="pb-6">
          <label for="street" class="block text-sm font-medium text-gray-700 dark:text-textDark">Street Name <span
              class="text-[#2E2E2E]">*</span></label>
          <input id="streetName" name="streetName" [(ngModel)]="personalData.streetName"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack"
            #streetNameInput="ngModel" required />
          <div *ngIf="streetNameInput.touched && !personalData.streetName" class="text-red-500 text-sm mt-1">
            <div>Street Name is required</div>
          </div>
        </div>

        <div class="pb-6">
          <label for="city" class="block text-sm font-medium text-gray-700 dark:text-textDark">City <span
              class="text-[#2E2E2E]">*</span></label>
          <input id="city" name="city" [(ngModel)]="personalData.city"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack"
            #cityInput="ngModel" required />
          <div *ngIf="cityInput.touched && !personalData.city" class="text-red-500 text-sm mt-1">
            <div>City is required</div>
          </div>
        </div>

        <div class="pb-6">
          <label for="district" class="block text-sm font-medium text-gray-700 dark:text-textDark">
            District <span class="text-[#2E2E2E]">*</span>
          </label>
          <p-dropdown inputId="district" name="district" [(ngModel)]="personalData.district" [options]="districts"
            optionLabel="name" optionValue="name" [filter]="true" filterBy="name" placeholder="Select a district"
            (onChange)="updateProvince($event)" (onBlur)="onBlur('district')"
            [ngClass]="{ 'p-invalid': isFieldInvalid('district') }" class="w-full" />

          <!-- Validation Message -->
          <div *ngIf="isFieldInvalid('district')" class="text-red-500 text-sm mt-1">
            District is required.
          </div>

        </div>

        <div class="pb-6">
          <label for="province" class="block text-sm font-medium text-gray-700 dark:text-textDark">
            Province
          </label>
          <input id="province" name="province" [(ngModel)]="personalData.province"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack"
            readonly />
        </div>

        <div class="pb-6">
          <label for="country" class="block text-sm font-medium text-gray-700 dark:text-textDark">Country</label>
          <input id="country" name="country" [(ngModel)]="personalData.country" disabled="true"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack"
            readonly />
        </div>
      </div>
    </div>
    <div>
      <h2 class="text-2xl mt-10 mb-6 text-textLight dark:text-textDark">
        Add Bank Details
      </h2>
      <div class="pb-6">
        <label for="accHolderName" class="block text-sm font-medium text-gray-700 dark:text-textDark">Account Holder's
          Name <span class="text-[#2E2E2E]">*</span></label>
        <input id="accHolderName" name="accHolderName" [(ngModel)]="personalData.accHolderName"
          (keydown)="validateNameInput($event)" (input)="capitalizeName('accHolderName')"
          class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack"
          #accHolderNameInput="ngModel" required />
        <div *ngIf="accHolderNameInput.touched && !personalData.accHolderName" class="text-red-500 text-sm mt-1">
          <div>Account Holder's name is required</div>
        </div>
        <div *ngIf="
            accHolderNameInput.touched &&
            personalData.accHolderName &&
            !isValidName(personalData.accHolderName)
          " class="text-red-500 text-sm mt-1">
          <div>
            Please use only letters, spaces, hyphens (-), and apostrophes (')
          </div>
        </div>
      </div>

      <div class="pb-6">
        <label for="accNumber" class="block text-sm font-medium text-gray-700 dark:text-textDark">Account Number <span
            class="text-[#2E2E2E]">*</span></label>
        <input id="accNumber" name="accNumber" [(ngModel)]="personalData.accNumber"
          class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack"
          #accNumberInput="ngModel" required pattern="^[0-9]+$" (keypress)="allowOnlyNumbers($event)" />
        <div *ngIf="accNumberInput.touched && !personalData.accNumber" class="text-red-500 text-sm mt-1">
          <div>Account Number is required</div>
        </div>
        <div *ngIf="accNumberInput.touched && personalData.accNumber && accNumberInput.errors?.['pattern']"
          class="text-red-500 text-sm mt-1">
          <div>Account Number cannot contain special characters</div>
        </div>
      </div>

      <div class="pb-6">
        <label for="confirmAccNumber" class="block text-sm font-medium text-gray-700 dark:text-textDark">
          Confirm Account Number <span class="text-[#2E2E2E]">*</span>
        </label>
        <input #confirmAccNumberInput="ngModel" id="confirmAccNumber" name="confirmAccNumber"
          [(ngModel)]="confirmAccNumber" (ngModelChange)="validateConfirmAccNumber()" pattern="^[0-9]+$"
          (keypress)="allowOnlyNumbers($event)"
          class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-textLight dark:text-textDark bg-tileLight dark:bg-tileBlack" />

        <span *ngIf="confirmAccountNumberRequired" class="text-red-600 text-sm">
          Confirm Account Number is required.
        </span>

        <span *ngIf="confirmAccountNumberError && !confirmAccountNumberRequired" class="text-red-600 text-sm">
          Account Numbers do not match.
        </span>

        <span
          *ngIf="confirmAccNumberInput.touched && this.confirmAccNumber && !confirmAccountNumberError && confirmAccNumberInput.errors?.['pattern']"
          class="text-red-500 text-sm mt-1">
          <div>Account Number cannot contain special characters</div>
        </span>
      </div>

      <div class="pb-6">
        <label for="bankDropdown" class="block text-sm font-medium text-gray-700 dark:text-textDark mb-1">
          Bank Name <span class="text-[#2E2E2E]">*</span>
        </label>
        <p-dropdown id="bankDropdown" name="bankDropdown" [(ngModel)]="selectedBankId" (onChange)="onBankChange()"
          (onClick)="onFieldTouched('bankName')" [options]="banks" optionLabel="name" optionValue="ID" [filter]="true"
          filterBy="name" placeholder="Select a bank" [showClear]="true"
          class="w-full text-textLight dark:text-textDark" [ngClass]="{
      'p-invalid': isFieldInvalid('bankName')
    }">
          <ng-template pTemplate="item" let-bank>
            <div class="text-textLight dark:text-textDark">{{ bank.name }}</div>
          </ng-template>
        </p-dropdown>
        <span *ngIf="isFieldInvalid('bankName')" class="text-red-600 text-sm">
          Bank Name is required.
        </span>
      </div>

      <div class="pb-6">
        <label for="branchDropdown" class="block text-sm font-medium text-gray-700 dark:text-textDark mb-1">
          Branch Name <span class="text-[#2E2E2E]">*</span>
        </label>
        <p-dropdown id="branchDropdown" name="branchDropdown" [(ngModel)]="selectedBranchId"
          (onChange)="onBranchChange()" (onClick)="onBranchTouched('branchName')" [options]="branches"
          optionLabel="name" optionValue="ID" [filter]="true" filterBy="name" placeholder="Select a branch"
          [showClear]="true" [disabled]="!selectedBankId" class="w-full text-textLight dark:text-textDark" [ngClass]="{
      'p-invalid': isFieldInvalid('branchName')
    }">
          <ng-template pTemplate="item" let-branch>
            <div class="text-textLight dark:text-textDark">
              {{ branch.name }}
            </div>
          </ng-template>
        </p-dropdown>
        <span *ngIf="isFieldInvalid('branchName')" class="text-red-600 text-sm">
          Branch Name is required.
        </span>
      </div>


      <div class="flex justify-end">
        <button (click)="onCancel()" type="button" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md mr-2">
          Cancel
        </button>
        <button type="submit" (click)="onSubmit()" [disabled]="!isFormValid()"
          class="px-4 py-2 bg-[#3980C0] text-white rounded-md">
          Submit
        </button>
      </div>
    </div>
  </div>
</div>