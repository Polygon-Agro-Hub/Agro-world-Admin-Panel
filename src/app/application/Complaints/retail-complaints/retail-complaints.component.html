<app-loading-spinner *ngIf="isLoading"></app-loading-spinner>

<button class="mb-5 text-textLight dark:text-textDark flex items-center" (click)="goBack()" aria-label="Go back">
  <i class="fa-solid fa-arrow-left mr-2"></i>
  Back
</button>

<div
  class="fixed-width-container overflow-x-auto scrollbar-thin scrollbar-thumb-[#8AC440] scrollbar-track-transparent scrollbar-thumb-rounded-full">
  <div class="pt-5 pr-12 pl-12 pb-5 min-w-[1400px] bg-tileLight dark:bg-tileBlack shadow-lg rounded-lg">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-[20px] md:text-[24px] font-normal text-gray-900 dark:text-gray-100">
        Complaint List ({{ totalItems < 10 ? '0' + totalItems : totalItems }}) </h2>
          <div class="flex items-center space-x-3">

            <i class="mr-4 w-6 h-6 fill-current text-textLight dark:text-textDark">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path
                  d="M0 416c0 17.7 14.3 32 32 32l54.7 0c12.3 28.3 40.5 48 73.3 48s61-19.7 73.3-48L480 448c17.7 0 32-14.3 32-32s-14.3-32-32-32l-246.7 0c-12.3-28.3-40.5-48-73.3-48s-61 19.7-73.3 48L32 384c-17.7 0-32 14.3-32 32zm128 0a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zM320 256a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zm32-80c-32.8 0-61 19.7-73.3 48L32 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l246.7 0c12.3 28.3 40.5 48 73.3 48s61-19.7 73.3-48l54.7 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-54.7 0c-12.3-28.3-40.5-48-73.3-48zM192 128a32 32 0 1 1 0-64 32 32 0 1 1 0 64zm73.3-64C253 35.7 224.8 16 192 16s-61 19.7-73.3 48L32 64C14.3 64 0 78.3 0 96s14.3 32 32 32l86.7 0c12.3 28.3 40.5 48 73.3 48s61-19.7 73.3-48L480 128c17.7 0 32-14.3 32-32s-14.3-32-32-32L265.3 64z"
                />
              </svg>
            </i>
    
            <p class="md:text-2xl lg:text-lg dark:text-textDark whitespace-nowrap flex-shrink-0 mr-5">Filter By</p>
            

            <!-- Category -->
            <p-dropdown
              styleClass="border border-2 rounded-xl h-8 items-center bg-[#F1F1F1] dark:bg-[#272F45] text-textLight dark:text-textDark border-gray-300 dark:border-[#AFAFAF]"
              [options]="comCategories" [(ngModel)]="filterComCategory" optionLabel="label" optionValue="value"
              [showClear]="true" placeholder="Category" (onChange)="applyFilters()"></p-dropdown>

            <!-- Status -->
            <p-dropdown
              styleClass="border border-2 rounded-xl h-8 items-center bg-[#F1F1F1] dark:bg-[#272F45] text-textLight dark:text-textDark border-gray-300 dark:border-[#AFAFAF]"
              [options]="status" [(ngModel)]="filterStatus" optionLabel="label" optionValue="value" [showClear]="true"
              placeholder="Status" (onChange)="applyFilters()"></p-dropdown>
            <!-- Reply Status -->
            <p-dropdown
              styleClass="border border-2 rounded-xl h-8 items-center bg-[#F1F1F1] dark:bg-[#272F45] text-textLight dark:text-textDark border-gray-300 dark:border-[#AFAFAF]"
              [options]="replyStatus" [(ngModel)]="rpst" optionLabel="label" optionValue="value" [showClear]="true"
              placeholder="Reply" (onChange)="regStatusFil()"></p-dropdown>

            <!-- Search -->
            <div class="flex items-center rounded-full px-2 py-1 w-96 bg-gray-100 dark:bg-gray-800">
              <input type="text" placeholder="Search by RefNo, Category, Name or Phone..." [(ngModel)]="searchText"
                (keyup.enter)="searchComplain()" (ngModelChange)="onSearchTextChange($event)"
                class="bg-transparent outline-none w-full text-gray-900 dark:text-gray-100" />
              <button type="button" (click)="searchComplain()" aria-label="Search"
                class="text-gray-500 hover:text-gray-700 focus:outline-none mr-1">
                <!-- magnifying-glass SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </button>
              <button type="button" class="text-gray-500 hover:text-gray-700 focus:outline-none" (click)="clearSearch()"
                aria-label="Clear search">
                <!-- X-icon SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>
    </div>

    <div *ngIf="!hasData"
      class="flex flex-col items-center w-full h-screen px-10 py-7 bg-tileLight dark:bg-[#363636] dark:text-textDark mt-6">
      <p class="text-[#494949] my-6 dark:text-textDark">--No Data Availabale--</p>
      <img src="assets/images/NoData.png" alt="No Data" class="w-20 h-20 dark:text-textDark" />
    </div>

    <div *ngIf="hasData" class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200 mt-6 dark:divide-[#4B555A] table-auto">
        <thead class="bg-white dark:bg-gray-800">
          <tr>
            <th
              class="py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">
              Ref No</th>
            <th
              class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">
              Category</th>
            <th
              class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">
              First Name</th>
            <th
              class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">
              Last Name</th>
            <th
              class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">
              Contact Number</th>
            <th
              class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">
              Received At</th>
            <th
              class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">
              Status</th>
            <th
              class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">
              View</th>
            <th
              class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">
              Reply</th>
            <th
              class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-gray-500 dark:text-gray-300 whitespace-nowrap text-center">
              View Reply</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="
              let item of
                filteredComplaints
                | paginate: {
                    itemsPerPage: itemsPerPage,
                    currentPage: page,
                    id: 'retailComplaintsPager'
                  }
            " class="text-gray-900 dark:text-gray-100">
            <td class="py-3 text-[14px] md:text-[16px] font-normal text-center whitespace-nowrap">
              {{ item.refNo }}
            </td>
            <td class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-center">
              {{ item.complainCategory }}
            </td>
            <td class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-center">
              {{ item.firstName }}
            </td>
            <td class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-center">
              {{ item.lastName }}
            </td>
            <td class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-center">
              {{ item.contactNumber }}
            </td>
            <td
            class="px-4 py-3 text-[14px] md:text-[16px] font-normal text-center text-gray-900 dark:text-gray-100 whitespace-nowrap">
            {{ item.createdAt | date: 'yyyy/MM/dd' }} at
            {{ item.createdAt | date: 'hh:mm a' }}
          </td>

            <td class="flex px-4 py-3 text-center justify-center">
              <span class="w-32 h-8 flex items-center justify-center font-medium rounded-md text-sm" [ngClass]="{
      'bg-green-100 text-green-600': item.status === 'Assigned',
      'bg-red-100 text-red-600': item.status === 'Pending',
      'bg-yellow-100 text-yellow-600': item.status === 'Closed'
    }" [ngStyle]="{
      'color': item.status==='Assigned'? '#308233':
               item.status==='Pending'? '#D16D6A':
               item.status==='Closed'? '#A8A100':'',
      'background-color': item.status==='Assigned'? '#BBFFC6':
                          item.status==='Pending'? '#FFB9B7':
                          item.status==='Closed'? '#F8FFA6':''
    }">
                {{ item.status }}
              </span>
            </td>

            <td class="px-3 py-2 whitespace-nowrap text-center">
              <button (click)="navigateSelectComplain(item.id)" class="text-blue-600 hover:text-blue-900"
                aria-label="View complaint details">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5">
                  <path
                    d="M3 14C3 9.02944 7.02944 5 12 5C16.9706 5 21 9.02944 21 14M17 14C17 16.7614 14.7614 19 12 19C9.23858 19 7 16.7614 7 14C7 11.2386 9.23858 9 12 9C14.7614 9 17 11.2386 17 14Z"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </button>
            </td>
            <td class="px-4 py-3 text-center">
              <span *ngIf="!item.reply && item.status !== 'Closed'" class="italic opacity-60 ">No</span>
              <span *ngIf="item.reply && item.status === 'Closed'" class="underline">Yes</span>
            </td>

            <td class="px-3 py-2 whitespace-nowrap text-center">
              <button (click)="item.reply && showReplyDialog(item)" [disabled]="!item.reply"
                [ngClass]="{'opacity-40 cursor-not-allowed': !item.reply}" class="text-blue-600 hover:text-blue-900"
                aria-label="View complaint reply">
                <img src="assets/icons/viewreply.png" alt="View Reply" class="w-6 h-6 inline-block" />

              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <pagination-controls [id]="'retailComplaintsPager'" (pageChange)="onPageChange($event)" previousLabel="Previous"
      nextLabel="Next"></pagination-controls>
  </div>
</div>

<!-- <p-dialog [(visible)]="display" [modal]="true" [closable]="false" [style]="{ width: '600px' }"
  [contentStyle]="{ padding: '0' }">
  <div class="dark:bg-tileBlack">
    <div class="dialog-header text-center">
      <i class="fa-regular fa-envelope" style="font-size: 1.5rem; color: #999"></i>
      <h3 class="text-[16px] md:text-[18px] font-semibold mt-3 text-[#000000]">Reply as Polygon</h3>
  
  
    </div>
    <div class="dialog-content text-[16px] md:text-[18px] border-t rounded-[20px]
   border-r border-b border-l border-gray-300 text-[#000000] mt-5 ml-8 mr-8 mb-5">
      <div class=" p-5 ">
        <div class="reply-header">
          <span>Dear {{ selectedComplaint.firstName }} {{ selectedComplaint.lastName }},</span>
          <p class="mt-3">We are pleased to inform you that your complaint has been resolved.</p>
        </div>
        <p *ngIf="selectedComplaint.reply" class="pre-filled-reply text-wrap">
          {{ selectedComplaint.reply }}
        </p>
  
  
        <p>
          If you have any further concerns or questions, feel free to reach out. <br>
          Thank you for your patience and understanding.
        </p>
  
        <p class="mt-5">
          Sincerely,<br />
          Polygon Customer Support Team
        </p>
      </div>
  
    </div>
    <ng-template pTemplate="footer">
      <button pButton type="button" label="Cancel" class="p-button-secondary" style="margin-right: 8px; background-color: #74788D; color: #D3D3D3; border: none; width: 120px; height: 40px;border: none;
  " (click)="hideDialog()"></button>
  
    </ng-template>
  </div>
</p-dialog> -->

<div *ngIf="display" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white dark:bg-tileBlack rounded-[20px] w-[600px] p-4">
    <div class="dialog-header text-center">
      <i class="fa-regular fa-envelope" style="font-size: 1.5rem; color: #999"></i>
      <h3 class="text-[16px] md:text-[18px] font-semibold mt-3 text-[#000000] dark:text-white">
        Reply as Polygon
      </h3>
    </div>

    <div class="dialog-content text-[16px] md:text-[18px] border rounded-[20px]
      border-gray-300 text-[#000000] dark:text-white mt-5 ml-4 mr-4 mb-5">
      <div class="p-5">
        <div class="reply-header">
          <span>Dear {{ selectedComplaint.firstName }} {{ selectedComplaint.lastName }},</span>
          <p class="mt-3">We are pleased to inform you that your complaint has been resolved.</p>
        </div>

        <p *ngIf="selectedComplaint.reply" class="pre-filled-reply text-wrap">
          {{ selectedComplaint.reply }}
        </p>

        <p>
          If you have any further concerns or questions, feel free to reach out. <br>
          Thank you for your patience and understanding.
        </p>

        <p class="mt-5">
          Sincerely,<br />
          Polygon Customer Support Team
        </p>
      </div>
    </div>

    <div class="flex justify-end px-5 pb-4">
      <button
        type="button"
        class="bg-[#74788D] text-[#D3D3D3] px-4 py-2 rounded-md"
        style="width: 120px; height: 40px;"
        (click)="hideDialog()"
      >
        Cancel
      </button>
    </div>
  </div>
</div>
