<app-loading-spinner *ngIf="isLoading"></app-loading-spinner>

<button class="mb-5 text-textLight dark:text-textDark" (click)="back()">
  <i class="fa-solid fa-arrow-left"></i> Back
</button>

<form>
  <!-- Save button -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 sm:gap-0">
    <p class="text-lg sm:text-xl text-[#292929] font-normal dark:text-textDark">Add Package</p>
    <div class="flex flex-row gap-2">
      <button type="button" class="bg-[#74788D] text-sm sm:text-lg text-white px-3 py-1 rounded-lg" (click)="onCancel()">
        Cancel
      </button>
      <button type="button" class="bg-[#3980C0] text-sm sm:text-lg text-white px-4 sm:px-5 py-1 rounded-lg" (click)="onSubmit()"
        [disabled]="
          this.packageObj.productPrice < 0.0 ||
          this.packageObj.packageFee < 0.0 ||
          this.packageObj.serviceFee < 0.0
        ">
        Save
      </button>
    </div>
  </div>

  <div class="flex flex-col lg:flex-row justify-between">
    <!-- Left Panel -->
    <div class="bg-[#FFFFFF] dark:bg-tileBlack py-10 px-6 sm:px-10 lg:px-14 shadow-md rounded-md w-full lg:w-[70%] mb-6 lg:mb-0">
      <div class="flex flex-row justify-between items-center mb-6">
        <!-- Display Package Name with validation -->
        <div class="w-[70%]">
          <label class="text-[#534E4E] dark:text-textDark">Display Package Name*</label>
          <input type="text" id="name" name="name" 
            [(ngModel)]="packageObj.displayName" 
            (input)="onDisplayNameChange($event)"
            (blur)="onDisplayNameBlur()"
            placeholder="Fruit Pack"
            class="mt-1 block w-full p-2 border border-[#D9D9D9] dark:border-gray-600 rounded-md text-black dark:text-textDark bg-tileLight dark:bg-tileBlack placeholder-gray-400 dark:placeholder-gray-500" />
          <!-- <div *ngIf="shouldShowDisplayNameError" class="text-red-500 text-sm mt-1">
            Display Package Name is required
          </div> -->
        </div>

        <!-- Image upload section with validation -->
        <div class="flex flex-row items-center gap-3 mt-6">
          <input type="file" id="imageUpload" accept="image/*" class="hidden" (change)="onFileSelected($event)" />
          <label class="text-[#534E4E] font-semibold dark:text-textDark">Add Image *</label>
          <div class="py-1 px-2 rounded-lg shadow-lg border border-[#3980C0] cursor-pointer"
            (click)="triggerFileInput($event)">
            <i class="fa-solid fa-plus text-3xl text-[#A3A3A3]"></i>
          </div>
        </div>
      </div>

      <!-- Image validation error message -->
      <!-- <div *ngIf="shouldShowImageError" class="text-red-500 text-sm mb-4">
        Package Image is required
      </div> -->

      <!-- Description with validation -->
      <div class="mb-6">
        <label class="text-[#534E4E] dark:text-textDark">Description*</label>
        <textarea rows="4" name="description" 
          [(ngModel)]="packageObj.description" 
          (input)="onDescriptionChange($event)"
          (blur)="onDescriptionBlur()"
          placeholder="Enter Description"
          class="mt-1 block w-full p-2 border border-[#D9D9D9] dark:border-gray-600 rounded-md text-black dark:text-textDark bg-tileLight dark:bg-tileBlack placeholder-gray-400 dark:placeholder-gray-500"></textarea>
        <!-- <div *ngIf="shouldShowDescriptionError" class="text-red-500 text-sm mt-1">
          Description is required
        </div> -->
      </div>

      <hr class="my-8 border border-[#D9D9D9] dark:border-gray-700" />

      <!-- Pricing Inputs with validation -->
      <div class="grid grid-cols-3 gap-8 mb-6">
        <div>
          <label class="block text-sm text-[#534E4E] font-medium mb-2 dark:text-textDark">
            Total Package Price (Rs.)*
          </label>
          <input type="number" min="0" step="0.01" name="productPrice" 
  [(ngModel)]="packageObj.productPrice"
  (change)="calculateApproximatedPrice(); validateDecimalInput($event, 'productPrice')" 
  (blur)="onProductPriceBlur(); validateDecimalInput($event, 'productPrice')"
  (input)="preventNegative($event)"
  (keypress)="allowDecimalNumbers($event)" 
  placeholder="Enter Amount"
  class="w-full border border-[#D9D9D9] dark:border-gray-600 rounded-md px-3 py-2 text-black dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <!-- <div *ngIf="shouldShowProductPriceError" class="text-red-500 text-sm mt-1">
            Total Package Price must be greater than 0
          </div> -->
        </div>

        <div>
          <label class="block text-sm text-[#534E4E] font-medium mb-2 dark:text-textDark">
            Packaging Fee (Rs.)*
          </label>
          <input type="number" min="0" step="0.01" name="packageFee" 
  [(ngModel)]="packageObj.packageFee"
  (change)="calculateApproximatedPrice(); validateDecimalInput($event, 'packageFee')" 
  (blur)="onPackageFeeBlur(); validateDecimalInput($event, 'packageFee')"
  (input)="preventNegative($event)"
  (keypress)="allowDecimalNumbers($event)" 
  placeholder="Enter Amount"
  class="w-full border border-[#D9D9D9] dark:border-gray-600 rounded-md px-3 py-2 text-black dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <!-- <div *ngIf="shouldShowPackageFeeError" class="text-red-500 text-sm mt-1">
            Packaging Fee cannot be negative
          </div> -->
        </div>

        <div>
          <label class="block text-sm text-[#534E4E] font-medium mb-2 dark:text-textDark">
            Service Fee (Rs.) *
          </label>
          <input type="number" min="0" step="0.01" name="serviceFee" 
  [(ngModel)]="packageObj.serviceFee"
  (change)="calculateApproximatedPrice(); validateDecimalInput($event, 'serviceFee')" 
  (blur)="onServiceFeeBlur(); validateDecimalInput($event, 'serviceFee')"
  (input)="preventNegative($event)"
  (keypress)="allowDecimalNumbers($event)" 
  placeholder="Enter Amount"
  class="w-full border border-[#D9D9D9] dark:border-gray-600 rounded-md px-3 py-2 text-black dark:text-textDark bg-tileLight dark:bg-tileBlack" />
          <!-- <div *ngIf="shouldShowServiceFeeError" class="text-red-500 text-sm mt-1">
            Service Fee cannot be negative
          </div> -->
        </div>
      </div>

      <!-- Approximated Price -->
      <div>
        <label class="block text-sm font-medium text-[#534E4E] mb-2 dark:text-textDark">
          Approximated Package Price (Rs.)
        </label>
        <input disabled type="text" [value]="packageObj.approximatedPrice | number: '1.2-2'" placeholder="--"
          class="w-full border border-[#D9D9D9] dark:border-gray-600 rounded-md px-3 py-2 bg-gray-100 dark:bg-gray-700 text-black dark:text-textDark" />
      </div>

      <hr class="my-8 border border-[#D9D9D9] dark:border-gray-700" />

      <!-- Product Types Table -->
      <div class="w-full mx-auto border border-gray-300 dark:border-gray-600 rounded-lg">
        <table class="w-full font-normal">
          <thead class="text-gray-500 dark:text-gray-300 border-b border-[#CFCFCF] dark:border-gray-700">
            <tr>
              <th class="text-left font-normal px-4 py-3">Product Type</th>
              <th class="text-right font-normal px-4 py-3">No. of Items</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of productTypeObj" class="border-b dark:border-gray-700">
              <td class="px-4 py-3 text-[#534E4E] dark:text-textDark">{{ item.typeName }}</td>
              <td class="px-4 py-2 text-right">
                <input type="number" min="0" [value]="packageObj.quantities[item.id]"
                  (input)="onInputChange(item.id, $event); preventNegative($event)"
                  (blur)="onQuantityBlur()"
                  (keypress)="allowOnlyNumbers($event)"
                  class="w-20 text-center border border-gray-300 dark:border-gray-600 rounded-md py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-tileBlack text-black dark:text-textDark"
                  placeholder="--" />
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Product type validation message -->
      <!-- <div *ngIf="shouldShowQuantityError" class="text-red-500 text-sm mt-2">
        You must select at least one product type with quantity greater than 0
      </div> -->
    </div>

    <!-- Right Panel: Preview & Status -->
    <div class="flex flex-col px-4 sm:px-6 py-3 lg:mx-6 w-full lg:w-[30%]">
      <!-- Preview -->
      <div class="rounded-lg px-6 sm:px-8 lg:px-12 py-4 sm:py-6 border border-[#CFCFCF] dark:bg-tileBlack">
        <p class="text-base sm:text-lg text-[#000000] dark:text-textDark font-normal">Preview</p>

        <div class="flex flex-col justify-center items-center relative my-3 bg-[#FFFFFF] dark:bg-gray-800 px-3 sm:px-5 py-3 h-auto rounded-xl shadow-md max-w-full">

          <div class="w-full flex justify-center items-center mt-4 sm:mt-6 lg:mt-8">
            <img *ngIf="selectedImage; else defaultIcon" [src]="selectedImage"
              class="w-full h-auto max-w-[200px] sm:max-w-[250px] lg:max-w-full object-contain px-2 sm:px-4 py-2" />
            <ng-template #defaultIcon>
              <div class="flex items-center justify-center w-full h-24 sm:h-28 lg:h-32 px-2 sm:px-4 py-2 text-gray-400">
                <i class="fa-solid fa-image text-4xl sm:text-6xl lg:text-9xl"></i>
              </div>
            </ng-template>
          </div>

          <div class="flex flex-col items-center justify-center gap-y-2 mt-2 sm:mt-3 pb-2 sm:pb-3">
            <p class="text-base sm:text-lg lg:text-xl text-[#393939] dark:text-textDark font-medium text-center px-2"
              *ngIf="packageObj.displayName; else noDisplayName">
              {{ packageObj.displayName }}
            </p>
            <ng-template #noDisplayName>
              <p class="text-sm sm:text-base lg:text-lg text-gray-500 italic">--Package Name--</p>
            </ng-template>

            <p class="text-base sm:text-lg text-[#00957D] font-medium" *ngIf="packageObj.approximatedPrice > 0; else noPrice">
              Rs.{{ packageObj.approximatedPrice | number: '1.2-2' }}
            </p>
            <ng-template #noPrice>
              <p class="text-xs sm:text-sm text-gray-500 italic">--Price--</p>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- Status -->
      <div class="bg-[#FFFFFF] dark:bg-tileBlack rounded-lg shadow-lg px-6 sm:px-8 lg:px-12 py-3 mt-6 sm:mt-8 lg:mt-10">
        <label class="text-sm sm:text-base text-[#000000] dark:text-textDark font-normal">Status</label>

        <div class="flex items-center space-x-2 my-3 sm:my-4 lg:my-5">
          <input class="w-4 h-4 sm:w-5 sm:h-5 text-[#534E4E]" type="radio" id="statusEnabled" name="status" [value]="'Enabled'"
            [(ngModel)]="packageObj.status" />
          <label for="statusEnabled" class="block text-sm font-medium text-gray-700 dark:text-textDark">
            Enabled
          </label>
        </div>

        <div class="flex items-center space-x-2 my-3 sm:my-4 lg:my-5">
          <input class="w-4 h-4 sm:w-5 sm:h-5 text-[#534E4E]" type="radio" id="statusDisabled" name="status" [value]="'Disabled'"
            [(ngModel)]="packageObj.status" />
          <label for="statusDisabled" class="block text-sm font-medium text-gray-700 dark:text-textDark">
            Disabled
          </label>
        </div>
      </div>
    </div>
  </div>
</form>