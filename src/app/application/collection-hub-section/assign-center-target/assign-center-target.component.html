<app-loading-spinner *ngIf="isLoading"></app-loading-spinner>

<div class="h-auto py-8 px-8">
  <div class="flex flex-row justify-between items-center">
    <p class="text-xl font-bold dark:text-white text-[#030308]">
      {{ centerDetails.regCode }} {{ centerDetails.centerName }}
    </p>
    <div class="flex flex-row items-center gap-5">
      <i class="fa-solid fa-list text-2xl dark:text-white ml-8"></i>

      <p class="font-normal dark:text-white">Filter By</p>

      <!-- <div class="relative w-46">
        <div
          class="border-2 rounded-xl dark:bg-[#292929] text-textLight dark:text-textDark flex flex-row justify-between items-center"
        >
          <input
            [(ngModel)]="selectDate"
            (change)="fetchSavedCenterCrops()"
            type="date"
            name="selectDate"
            class="block w-auto appearance-none dark:bg-[#292929] text-textLight dark:text-textDark px-3 py-2 rounded-xl focus:outline-none cursor-pointer"
          />
        </div>
      </div> -->
<div class="mr-5">
  <p-calendar
    id="toDate"
    [(ngModel)]="selectDate"
    (onSelect)="onDateChange($event)"
    (onClear)="onDateChange(null)"
    (onClose)="checkDateSelection()"
    [showIcon]="true"
    [showClear]="true"
    [showButtonBar]="true"
    placeholder="Select Date"
    iconDisplay="input"
    [style]="{ width: '16rem', height: '2rem' }"
    panelStyleClass="calendar-popup-small rounded-xl dark:bg-[#2d354d] dark:text-textDark dark:border-gray-600
                     [&_.p-datepicker-calendar_td_span:hover]:dark:bg-[#4a5568]
                     [&_.p-datepicker-calendar_td_span:hover]:dark:text-white
                     [&_.p-datepicker-header]:dark:bg-[#2d354d]
                     [&_.p-datepicker-header]:dark:text-white
                     [&_.p-datepicker-buttonbar]:dark:bg-[#2d354d]
                     [&_.p-button:hover]:dark:bg-[#6b7280]"
    inputStyleClass="p-2 border cursor-pointer rounded-xl bg-[#F1F1F1] dark:bg-[#272F45] text-textLight dark:text-textDark w-64 h-8 pr-12"
    [appendTo]="'body'"
  ></p-calendar>

  <!-- Validation message -->
  <p *ngIf="dateError" class="text-red-500 mt-1">Please select the date to display target.</p>
</div>


      <div
        class="flex items-center rounded-full px-4 py-2 w-96 bg-[#F1F1F1] dark:bg-[#272F45]"
      >
        <input
          [(ngModel)]="searchText"
          (keyup.enter)="onSearch()"
          (keyup.esc)="offSearch()"
          type="text"
          placeholder="Search by Crop / Variety Name"
          class="bg-transparent  outline-none w-full text-textLight dark:text-textDark"
        />
        <button
          (click)="onSearch()"
          type="button"
          class="text-gray-500 hover:text-gray-700 focus:outline-none mr-2"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 10-14 0 7 7 0 0014 0z"
            />
          </svg>
        </button>
        <button
          (click)="offSearch()"
          type="button"
          class="text-gray-500 hover:text-gray-700 focus:outline-none"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="!hasData" class="flex flex-col justify-start items-center pt-32 h-screen">
    <p class="text-[#494949] dark:text-textDark mb-4">
      -- No Data Available --
    </p>
    <div class="items-center">
      <img src="assets/images/NoData.png" alt="No Data" class="w-20 h-20 mb-4" />
    </div>
  </div>

  <div
    *ngIf="hasData"
    class="w-full px-10 py-7 bg-tileLight dark:bg-tileBlack rounded-lg my-8"
  >
    <div
      class="overflow-x-auto mt-8 mr-5 border-gray-100 border-[2px] rounded-lg"
    >
      <table class="w-full divide-y-2 overflow-hidden">
        <thead class="dark:bg-[#272F45] text-gray-700 dark:text-gray-300">
          <tr>
            <th class="px-6 py-3 text-left font-medium">
              ITEM ({{ countCrops < 10 ? "0" + countCrops : countCrops }})
            </th>
            <th class="px-6 py-3 text-left font-medium">Crop</th>
            <th class="px-6 py-3 text-left font-medium">Variety</th>
            <th class="px-6 py-3 text-left font-medium">Grade A</th>
            <th class="px-6 py-3 text-left font-medium">Grade B</th>
            <th class="px-6 py-3 text-left font-medium">Grade C</th>
          </tr>
        </thead>
        <tbody class="bg-white dark:bg-[#1E293B]">
          <tr *ngFor="let item of assignCropsArr; let i = index">
            <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">
              {{ i + 1 < 10 ? "0" + (i + 1) : i + 1 }}
            </td>
            <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">
              {{ item.cropNameEnglish }}
            </td>
            <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">
              {{ item.varietyNameEnglish }}
            </td>

            <!-- Grade A Column -->
            <td class="px-6 py-4 text-gray-900 dark:text-gray-300">
              <input
                [(ngModel)]="item.targetA"
                type="number"
                name="targetA"
                min="0"
                class="border-[#3980C0] dark:bg-[#272F45] border-[2px] border-dotted rounded-lg w-20 px-2 py-1 mr-4"
                [disabled]="!isNew && !item.editingA"
                (change)="validateForm()" 
                (keypress)="allowOnlyDigits($event)"
  (input)="removeLeadingZeros(item)"
              />
              <button
                *ngIf="!isNew && !item.editingA && isDateValid"
                (click)="(item.editingA = true) && pressEditIcon(item,'A')"
              >
                <i class="fa-solid fa-pen-to-square text-[#3980C0] text-xl"></i>
              </button>
              <!-- <button
                *ngIf="!isNew && item.editingA && isDateValid"
                class="bg-[#3980C0] px-3 py-2 text-white rounded-lg"
                (click)="saveGrade('A', item, item.targetA, item.idA)"
              >
                Save
              </button> -->

              <button *ngIf="!isNew && item.editingA && isDateValid"
                                class="px-3 py-2 text-white rounded-lg" [ngClass]="{
                                    'bg-[#415CFF]': item.preValueA !== item.targetA,
                                    'bg-[#6B7D8C]': item.preValueA === item.targetA || item.targetA < 0 || item.targetA < item.preValueA
                                  }"
                                (click)="item.preValueA !== item.targetA && item.targetA >= 0 && saveGrade('A', item, item.targetA, item.idA)">
                                Save
                            </button>
            </td>

            <!-- Grade B Column -->
            <td class="px-6 py-4 text-gray-900 dark:text-gray-300">
              <input
  [(ngModel)]="item.targetB"
  type="text"
  name="targetB"
  class="border-[#3980C0] dark:bg-[#272F45] border-[2px] border-dotted rounded-lg w-20 px-2 py-1 mr-4"
  [disabled]="!isNew && !item.editingB"
  (keypress)="allowOnlyDigits($event)"
  (input)="removeLeadingZeros(item)"
  (change)="validateForm()"
/>
              <button
                *ngIf="!isNew && !item.editingB && isDateValid"
                (click)="(item.editingB = true) && pressEditIcon(item,'B')"
              >
                <i class="fa-solid fa-pen-to-square text-[#3980C0] text-xl"></i>
              </button>

              <button *ngIf="!isNew && item.editingB && isDateValid" [ngClass]="{
                'bg-[#415CFF]': item.preValueB !== item.targetB,
                'bg-[#6B7D8C]': item.preValueB === item.targetB || item.targetB < 0 || item.targetB < item.preValueB
              }" class="px-3 py-2 text-white rounded-lg"
                (click)="item.preValueB !== item.targetB && item.targetB >= 0 && saveGrade('B', item, item.targetB, item.idB)">
                Save
            </button>
              <!-- <button
                *ngIf="!isNew && item.editingB && isDateValid"
                class="bg-[#3980C0] px-3 py-2 text-white rounded-lg"
                (click)="saveGrade('B', item, item.targetB, item.idB)"
              >
                Save
              </button> -->
            </td>

            <!-- Grade C Column -->
            <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">
              <input
                [(ngModel)]="item.targetC"
                type="number"
                name="targetC"
                min="0"
                class="border-[#3980C0] dark:bg-[#272F45] border-[2px] border-dotted rounded-lg w-16 px-2 py-1 mr-4"
                [disabled]="!isNew && !item.editingC"
                (change)="validateForm()"
                (keypress)="allowOnlyDigits($event)"
                (input)="removeLeadingZeros(item)"
              />
              <button
                *ngIf="!isNew && !item.editingC && isDateValid"
                (click)="(item.editingC = true) && pressEditIcon(item,'C')"
              >
                <i class="fa-solid fa-pen-to-square text-[#3980C0] text-xl"></i>
              </button>

              <button *ngIf="!isNew && item.editingC && isDateValid" [ngClass]="{
                'bg-[#415CFF]': item.preValueC !== item.targetC,
                'bg-[#6B7D8C]': (item.preValueC === item.targetC) || item.targetC < 0 || item.targetC < item.preValueC
              }" class="px-3 py-2 text-white rounded-lg"
                (click)="item.preValueC !== item.targetC && item.targetC >= 0 && saveGrade('C', item, item.targetC, item.idC)">
                Save
            </button>
              <!-- <button
                *ngIf="!isNew && item.editingC && isDateValid"
                class="bg-[#3980C0] px-3 py-2 text-white rounded-lg"
                (click)="saveGrade('C', item, item.targetC, item.idC)"
              >
                Save
              </button> -->
            </td>
          </tr>
        </tbody>
      </table>
  
    </div>
        
    <div
      *ngIf="isNew && isDateValid"
      class="flex flex-row justify-center items-center my-7 gap-8"
    >
      <button
        class="bg-[#FFFFFF] dark:bg-[#74788D] text-[#6B7D8C] dark:text-[#D3D3D3] border-[2px] border-[#95A1AC] rounded-lg px-5 py-2"
        (click)="onCancel()"
      >
        Cancel
      </button>
      <button (click)="onSubmit()"
        class="rounded-lg px-7 py-2"
        [ngClass]="
          isFormValid
            ? 'bg-[#3980C0] text-[#FFFFFF]'
            : 'bg-[#95A1AC] text-[#6B7D8C] dark:bg-[#74788D] dark:text-[#384957]'
        "
      >
        Save
      </button>
    </div>
  </div>
</div>
